
  "tab_bi_agr_direction_education":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_education
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_education
                        select
	                      report_date,
	                      company_name,
	                      itn,
	                      bo.name as category_name,
	                      cat_tot.name,
	                      amount_prev_day,
	                      sum_prev_day,
	                      amount_7_day,
	                      sum_7_day,
	                      amount_prev_month,
	                      sum_prev_month,
	                      total_amount,
	                      total_sum
                        from (
	                      SELECT 
                            today()-1 as report_date,
	                        bpt.name AS company_name,
                            bpt.itn AS itn,
                            sca.name as name,
                            sum(CASE WHEN created_date >= toDate(today()) - 1 AND created_date < today() THEN 1 ELSE 0 END) AS amount_prev_day,
                            case
                              when sum(sum) filter (where created_date >= today() - 1 and created_date < today()) is NULL then 0
                              else sum(sum) filter (where created_date >= today() - 1 and created_date < today())
                            end AS sum_prev_day,
                            sum(CASE WHEN created_date >= toDate(today()) - 7 AND created_date < today() THEN 1 ELSE 0 END) AS amount_7_day,
                            case
                              when sum(sum) filter (where created_date >= today() - 7 and created_date < today()) is NULL then 0
                              else sum(sum) filter (where created_date >= today() - 7 and created_date < today())
                            end AS sum_7_day,
                            sum(CASE WHEN created_date >= date_trunc('month', today() - INTERVAL 1 MONTH) and created_date < date_trunc('month', today()) THEN 1 ELSE 0 END) AS amount_prev_month,
                            case
                              when sum(sum) filter (where created_date>=date_trunc('month', today() - INTERVAL 1 MONTH) and created_date<date_trunc('month', today())) is NULL then 0
                              else sum(sum) filter (where created_date>=date_trunc('month', today() - INTERVAL 1 MONTH) and created_date<date_trunc('month', today()))
                            end AS sum_prev_month,
                            count(bpt.purchase_id) AS total_amount,
                            SUM(bpt.sum) AS total_sum
                          from oplati_analytic.bi_pos_type bpt
                          left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
                          left join oplati_analytic.spr_poi_app_channels spac on spac.cashbox_number=sca.reg_num
                          left join oplati_analytic.spr_poi_app spa on spac.app_id=spa.id
                          left join oplati_analytic.spr_poi_app_category t1 on t1.id=spa.category_id
                          where spa.name is not null and bpt.status = 1
   	                        and bpt.itn in (
   		                      '193775597', '193578419', '491702640', '391942045', '391107791', '193750099', '591970689', '391016033', '192813839',
		                      '191376663', '291754200', '591908766', '491387354', '291800587', '391939022', '193717440', '192972392', '193749492',
		                      '693326300', '193733821', '791347435', '193745308', '193282429', '791351441', '791351495', '291820897', '191275500',
		                      '491345076', '193109714', '691647647', '591757265', '193688337', '193680004', '193679265', '491606786', '791193624',
		                      '193309996', '193698816', '192525546', '193292872', '791349070', '192531356', '291615087', '291830355', '491656083',
		                      '193702738', '691644081', '193703484', '193664723', '193652823', '193669010', '591044914', '591044649', '591044702',
		                      '591044598', '591044608', '291769444', '791344224', '193665638', '791344303', '100904785', '391776109', '491382906',
		                      '791320332', '391785954', '192035737', '193686319', '391935892', '291809410', '600183248', '591043310', '193642040',
		                      '491627972', '193632899', '192607977', '193589869', '193671938', '491674467', '491336836', '193664205', '193577282',
		                      '192322903', '692258561', '391809139', '192592246', '391840672', '491335416', '491546336', '193651393', '193641108',
		                      '391841533', '691977970', '193643593', '491546004', '791296708', '791280195', '790827061', '192533425', '192031320',
		                      '491528136', '192978150', '192014951', '591039955', '192426307', '491592102', '691914529', '491052840', '591037383',
		                      '491227771', '692197924', '791222845', '692188625', '193495007', '191451701', '193562620', '591708089', '791279254',
		                      '193592613', '193154604', '291707808', '193454177', '190908260', '491429180', '391853617', '590373024', '591182174',
		                      '491227598', '591273983', '491526105', '700192265', '490963626', '192237146', '193139735', '291546997', '391271602',
		                      '790916809', '391309767', '191274599', '193125327', '791021927', '491065351', '191442721', '600102127', '490320109',
		                      '192671808', '201031439', '192538626', '291510978', '590767974', '192011222', '691720141', '191435318', '791189128',
		                      '500134647', '291660880', '491411744', '591033362', '391813104', '791025100', '101522289', '791066714', '191308663',
		                      '100582412', '691587598', '791107636', '192716860', '500065801', '391726602', '100124517', '500016985', '490858817',
		                      '290473286', '391810424', '191150091', '290983548', '290983507', '100027735', '192075193', '600095711', '200244780',
		                      '700181333', '600042065', '390540824', '691795399', '191106976', '500161273', '190639771', '101117830', '390540865'
		                    )
                          group by bpt.name, bpt.itn, sca.name
                        ) as cat_tot
                        left join oplati_analytic.bi_organisation bo 
                        on bo.unp  = cat_tot.itn;"

  "tab_bi_agr_direction_education_inact_cash":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_education_inact_cash
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_education_inact_cash
                        select  
	                      today() - 1 as report_date,
	                      bop.name as ul_name,
	                      bop.itn,
	                      bop.type_name as category_name,
	                      pos_name,
	                      cashbox_number
                        from oplati_analytic.spr_cashbox_area sca 
                        right join oplati_analytic.spr_poi_app_channels spac on spac.cashbox_number=sca.reg_num
                        left join oplati_analytic.spr_poi_app spa on spac.app_id=spa.id
                        left join oplati_analytic.spr_poi_app_category t1 on t1.id=spa.category_id
                        left join oplati_analytic.spr_pos_area spa2 on spa2.pos_id  = sca.pos_id
                        left join oplati_analytic.bi_organisation_payments bop  on spa2.org_id  = bop.org_id
                        where spa.name is not null and sca.cash_id  not in (select distinct device_id from oplati_analytic.bi_pos_type bpt)
	                    and bop.itn in (
   		                  '193775597', '193578419', '491702640', '391942045', '391107791', '193750099', '591970689', '391016033', '192813839',
		                  '191376663', '291754200', '591908766', '491387354', '291800587', '391939022', '193717440', '192972392', '193749492',
		                  '693326300', '193733821', '791347435', '193745308', '193282429', '791351441', '791351495', '291820897', '191275500',
		                  '491345076', '193109714', '691647647', '591757265', '193688337', '193680004', '193679265', '491606786', '791193624',
		                  '193309996', '193698816', '192525546', '193292872', '791349070', '192531356', '291615087', '291830355', '491656083',
		                  '193702738', '691644081', '193703484', '193664723', '193652823', '193669010', '591044914', '591044649', '591044702',
		                  '591044598', '591044608', '291769444', '791344224', '193665638', '791344303', '100904785', '391776109', '491382906',
		                  '791320332', '391785954', '192035737', '193686319', '391935892', '291809410', '600183248', '591043310', '193642040',
		                  '491627972', '193632899', '192607977', '193589869', '193671938', '491674467', '491336836', '193664205', '193577282',
		                  '192322903', '692258561', '391809139', '192592246', '391840672', '491335416', '491546336', '193651393', '193641108',
		                  '391841533', '691977970', '193643593', '491546004', '791296708', '791280195', '790827061', '192533425', '192031320',
		                  '491528136', '192978150', '192014951', '591039955', '192426307', '491592102', '691914529', '491052840', '591037383',
		                  '491227771', '692197924', '791222845', '692188625', '193495007', '191451701', '193562620', '591708089', '791279254',
		                  '193592613', '193154604', '291707808', '193454177', '190908260', '491429180', '391853617', '590373024', '591182174',
		                  '491227598', '591273983', '491526105', '700192265', '490963626', '192237146', '193139735', '291546997', '391271602',
		                  '790916809', '391309767', '191274599', '193125327', '791021927', '491065351', '191442721', '600102127', '490320109',
		                  '192671808', '201031439', '192538626', '291510978', '590767974', '192011222', '691720141', '191435318', '791189128',
		                  '500134647', '291660880', '491411744', '591033362', '391813104', '791025100', '101522289', '791066714', '191308663',
		                  '100582412', '691587598', '791107636', '192716860', '500065801', '391726602', '100124517', '500016985', '490858817',
		                  '290473286', '391810424', '191150091', '290983548', '290983507', '100027735', '192075193', '600095711', '200244780',
		                  '700181333', '600042065', '390540824', '691795399', '191106976', '500161273', '190639771', '101117830', '390540865'
		                );"

  "tab_bi_agr_direction_daily":
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_daily
                        select 
	                        oper.report_date,
	                        catalog_amount_operation,
	                        catalog_internet_cashbox,
	                        education_amount_operation,
	                        education_internet_cashbox
                        from (
	                        select 
    	                        DATE_TRUNC('day', created_date) AS report_date,
	                            round(count(purchase_id), 2) AS catalog_amount_operation
	                        from oplati_analytic.bi_pos_type_2023 bpt
   	                        left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
   	                        left join oplati_analytic.spr_poi_app_channels spac on spac.cashbox_number=sca.reg_num
   	                        left join oplati_analytic.spr_poi_app spa on spac.app_id=spa.id
   	                        left join oplati_analytic.spr_poi_app_category t1 on t1.id=spa.category_id
   	                        where spa.name is not NULL and bpt.status=1 and toDate(created_date) = today() - 1
                            GROUP BY DATE_TRUNC('day', created_date)
                        )oper
                        
                        left join (
	                        select 
                            	DATE_TRUNC('day', open_date) AS report_date,
                            	round(count(distinct spac.cashbox_number), 2) AS catalog_internet_cashbox
   	                        from oplati_analytic.spr_cashbox_area sca 
   	                        left join oplati_analytic.spr_poi_app_channels spac on spac.cashbox_number=sca.reg_num
   	                        left join oplati_analytic.spr_poi_app spa on spac.app_id=spa.id
   	                        left join oplati_analytic.spr_poi_app_category t1 on t1.id=spa.category_id
   	                        where spa.name is not NULL and open_date::date = today() - 1
	                        GROUP BY DATE_TRUNC('day', open_date)	
                        ) op_count
                        on oper.report_date = op_count.report_date

                        left join (
	                        select 
	                            DATE_TRUNC('day', created_date) AS report_date,
    	                        round(count(purchase_id), 2) AS education_amount_operation
                            from oplati_analytic.bi_pos_type_2023 bpt
                            where bpt.status=1 and toDate(created_date) = today() - 1
   	                            and bpt.itn in (
		                            '193775597', '193578419', '491702640', '391942045', '391107791', '193750099', '591970689', '391016033', '192813839',
		                            '191376663', '291754200', '591908766', '491387354', '291800587', '391939022', '193717440', '192972392', '193749492',
		                            '693326300', '193733821', '791347435', '193745308', '193282429', '791351441', '791351495', '291820897', '191275500',
		                            '491345076', '193109714', '691647647', '591757265', '193688337', '193680004', '193679265', '491606786', '791193624',
		                            '193309996', '193698816', '192525546', '193292872', '791349070', '192531356', '291615087', '291830355', '491656083',
		                            '193702738', '691644081', '193703484', '193664723', '193652823', '193669010', '591044914', '591044649', '591044702',
		                            '591044598', '591044608', '291769444', '791344224', '193665638', '791344303', '100904785', '391776109', '491382906',
		                            '791320332', '391785954', '192035737', '193686319', '391935892', '291809410', '600183248', '591043310', '193642040',
		                            '491627972', '193632899', '192607977', '193589869', '193671938', '491674467', '491336836', '193664205', '193577282',
		                            '192322903', '692258561', '391809139', '192592246', '391840672', '491335416', '491546336', '193651393', '193641108',
		                            '391841533', '691977970', '193643593', '491546004', '791296708', '791280195', '790827061', '192533425', '192031320',
		                            '491528136', '192978150', '192014951', '591039955', '192426307', '491592102', '691914529', '491052840', '591037383',
		                            '491227771', '692197924', '791222845', '692188625', '193495007', '191451701', '193562620', '591708089', '791279254',
		                            '193592613', '193154604', '291707808', '193454177', '190908260', '491429180', '391853617', '590373024', '591182174',
		                            '491227598', '591273983', '491526105', '700192265', '490963626', '192237146', '193139735', '291546997', '391271602',
		                            '790916809', '391309767', '191274599', '193125327', '791021927', '491065351', '191442721', '600102127', '490320109',
		                            '192671808', '201031439', '192538626', '291510978', '590767974', '192011222', '691720141', '191435318', '791189128',
		                            '500134647', '291660880', '491411744', '591033362', '391813104', '791025100', '101522289', '791066714', '191308663',
		                            '100582412', '691587598', '791107636', '192716860', '500065801', '391726602', '100124517', '500016985', '490858817',
		                            '290473286', '391810424', '191150091', '290983548', '290983507', '100027735', '192075193', '600095711', '200244780',
		                            '700181333', '600042065', '390540824', '691795399', '191106976', '500161273', '190639771', '101117830', '390540865')
	                        GROUP BY DATE_TRUNC('day', created_date)
                        ) oper_edu
                        on oper.report_date = oper_edu.report_date

                        left join (
	                        select 
	                            DATE_TRUNC('day', sca.open_date) AS report_date,
    	                        round(count(distinct spac.cashbox_number), 2) AS education_internet_cashbox
   	                        from oplati_analytic.spr_cashbox_area sca 
   	                        left join oplati_analytic.spr_poi_app_channels spac on spac.cashbox_number=sca.reg_num
   	                        left join oplati_analytic.spr_poi_app spa on spac.app_id=spa.id
   	                        left join oplati_analytic.spr_poi_app_category t1 on t1.id=spa.category_id
   	                        left join oplati_analytic.spr_pos_area spos on sca.pos_id = spos.pos_id
   	                        left join oplati_analytic.spr_organisation so on spos.org_id = so.org_id 
   	                        where spa.name is not NULL and sca.open_date::date = today() - 1
                                and so.itn in (
		                            '193775597', '193578419', '491702640', '391942045', '391107791', '193750099', '591970689', '391016033', '192813839',
		                            '191376663', '291754200', '591908766', '491387354', '291800587', '391939022', '193717440', '192972392', '193749492',
		                            '693326300', '193733821', '791347435', '193745308', '193282429', '791351441', '791351495', '291820897', '191275500',
		                            '491345076', '193109714', '691647647', '591757265', '193688337', '193680004', '193679265', '491606786', '791193624',
		                            '193309996', '193698816', '192525546', '193292872', '791349070', '192531356', '291615087', '291830355', '491656083',
		                            '193702738', '691644081', '193703484', '193664723', '193652823', '193669010', '591044914', '591044649', '591044702',
		                            '591044598', '591044608', '291769444', '791344224', '193665638', '791344303', '100904785', '391776109', '491382906',
		                            '791320332', '391785954', '192035737', '193686319', '391935892', '291809410', '600183248', '591043310', '193642040',
		                            '491627972', '193632899', '192607977', '193589869', '193671938', '491674467', '491336836', '193664205', '193577282',
		                            '192322903', '692258561', '391809139', '192592246', '391840672', '491335416', '491546336', '193651393', '193641108',
		                            '391841533', '691977970', '193643593', '491546004', '791296708', '791280195', '790827061', '192533425', '192031320',
		                            '491528136', '192978150', '192014951', '591039955', '192426307', '491592102', '691914529', '491052840', '591037383',
		                            '491227771', '692197924', '791222845', '692188625', '193495007', '191451701', '193562620', '591708089', '791279254',
		                            '193592613', '193154604', '291707808', '193454177', '190908260', '491429180', '391853617', '590373024', '591182174',
		                            '491227598', '591273983', '491526105', '700192265', '490963626', '192237146', '193139735', '291546997', '391271602',
		                            '790916809', '391309767', '191274599', '193125327', '791021927', '491065351', '191442721', '600102127', '490320109',
		                            '192671808', '201031439', '192538626', '291510978', '590767974', '192011222', '691720141', '191435318', '791189128',
		                            '500134647', '291660880', '491411744', '591033362', '391813104', '791025100', '101522289', '791066714', '191308663',
		                            '100582412', '691587598', '791107636', '192716860', '500065801', '391726602', '100124517', '500016985', '490858817',
		                            '290473286', '391810424', '191150091', '290983548', '290983507', '100027735', '192075193', '600095711', '200244780',
		                            '700181333', '600042065', '390540824', '691795399', '191106976', '500161273', '190639771', '101117830', '390540865')
	                        GROUP BY DATE_TRUNC('day', sca.open_date)	
                        ) edu_op_count
                        on oper.report_date = edu_op_count.report_date
                        order by oper.report_date desc;"

  "tab_bi_agr_direction_monthly":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_monthly
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_monthly
                        select
	                        cat.report_date,
	                        catalog_avg_check,
	                        catalog_sum_amount,
	                        education_avg_check,
	                        education_sum_amount
                        from(
	                        select 
		                        DATE_TRUNC('month', created_date) AS report_date,
	                            round(AVG(sum), 2) AS catalog_avg_check,
    	                        round(sum(sum), 2) AS catalog_sum_amount
	                        from oplati_analytic.bi_pos_type_2023 bpt
   	                        left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
	                        left join oplati_analytic.spr_poi_app_channels spac on spac.cashbox_number=sca.reg_num
   	                        left join oplati_analytic.spr_poi_app spa on spac.app_id=spa.id
   	                        left join oplati_analytic.spr_poi_app_category t1 on t1.id=spa.category_id
   	                        where spa.name is not NULL and bpt.status=1 and DATE_TRUNC('month', created_date) = DATE_TRUNC('month', today() - 1)
	                        GROUP BY DATE_TRUNC('month', created_date)
                        ) cat

                        left join (
	                        select 
								DATE_TRUNC('month', created_date) AS report_date,
	    						round(AVG(bpt.sum), 2) AS education_avg_check,
						    	round(sum(bpt.sum), 2) AS education_sum_amount
							from oplati_analytic.bi_pos_type_2023 bpt
							where bpt.status=1
								and date_trunc('month', bpt.created_date) = date_trunc('month', today() - 1)
						   		and bpt.itn in (
									'193775597', '193578419', '491702640', '391942045', '391107791', '193750099', '591970689', '391016033', '192813839',
								    '191376663', '291754200', '591908766', '491387354', '291800587', '391939022', '193717440', '192972392', '193749492',
								    '693326300', '193733821', '791347435', '193745308', '193282429', '791351441', '791351495', '291820897', '191275500',
								    '491345076', '193109714', '691647647', '591757265', '193688337', '193680004', '193679265', '491606786', '791193624',
		    						'193309996', '193698816', '192525546', '193292872', '791349070', '192531356', '291615087', '291830355', '491656083',
		    						'193702738', '691644081', '193703484', '193664723', '193652823', '193669010', '591044914', '591044649', '591044702',
		    						'591044598', '591044608', '291769444', '791344224', '193665638', '791344303', '100904785', '391776109', '491382906',
		    						'791320332', '391785954', '192035737', '193686319', '391935892', '291809410', '600183248', '591043310', '193642040',
		    						'491627972', '193632899', '192607977', '193589869', '193671938', '491674467', '491336836', '193664205', '193577282',
		    						'192322903', '692258561', '391809139', '192592246', '391840672', '491335416', '491546336', '193651393', '193641108',
		    						'391841533', '691977970', '193643593', '491546004', '791296708', '791280195', '790827061', '192533425', '192031320',
		    						'491528136', '192978150', '192014951', '591039955', '192426307', '491592102', '691914529', '491052840', '591037383',
		    						'491227771', '692197924', '791222845', '692188625', '193495007', '191451701', '193562620', '591708089', '791279254',
		    						'193592613', '193154604', '291707808', '193454177', '190908260', '491429180', '391853617', '590373024', '591182174',
		    						'491227598', '591273983', '491526105', '700192265', '490963626', '192237146', '193139735', '291546997', '391271602',
		    						'790916809', '391309767', '191274599', '193125327', '791021927', '491065351', '191442721', '600102127', '490320109',
		    						'192671808', '201031439', '192538626', '291510978', '590767974', '192011222', '691720141', '191435318', '791189128',
		    						'500134647', '291660880', '491411744', '591033362', '391813104', '791025100', '101522289', '791066714', '191308663',
		    						'100582412', '691587598', '791107636', '192716860', '500065801', '391726602', '100124517', '500016985', '490858817',
		    						'290473286', '391810424', '191150091', '290983548', '290983507', '100027735', '192075193', '600095711', '200244780',
		    						'700181333', '600042065', '390540824', '691795399', '191106976', '500161273', '190639771', '101117830', '390540865')
		    
							GROUP BY DATE_TRUNC('month', created_date)
                        ) edu
                        on cat.report_date = edu.report_date
                        ORDER BY report_date asc;"

  "tab_bi_activity_pos_monthly_type":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_activity_pos_monthly_type
    datetime_field: date
    recount_period: month
    remove_current: remove
    clickhouse_query: "insert into oplati_views_report.bi_activity_pos_monthly_type 
                        select
	                        DATE_TRUNC('month', date) AS date,
	                        type_name AS type_name,
	                        sum(active) AS amount_act
                        FROM (
	                        SELECT
	                        	DATE_TRUNC('month', created_date) AS date,
	                        	type_name,
	                        	count(DISTINCT pos_id) as active,
	                        	cum_sum
	                        FROM oplati_analytic.bi_pos_type bp
	                        left join (
	                        	SELECT
	                        		date,
	                        		sum(amount) over (order by date) as cum_sum
	                        	FROM (
	                        		SELECT
	                        			DATE_TRUNC('month', open_date) AS date,
	                        		    count(distinct pos_id) as amount
	                        		FROM oplati_analytic.spr_pos_area
	                        		group by date
	                        	) AS t
	                        ) t2
	                        on DATE_TRUNC('month', created_date)=t2.date where bp.status =1
	                        GROUP BY DATE_TRUNC('month', created_date), cum_sum, type_name
                        ) AS virtual_table

                        JOIN (
	                        SELECT
	                        	type_name AS type_name__,
	                        	sum(active) AS mme_inner__
	                        FROM (
	                        	SELECT
	                        		DATE_TRUNC('month', created_date) AS date,
	                        		type_name,
	                        		count(DISTINCT pos_id) as active,
	                        		cum_sum
	                        	FROM oplati_analytic.bi_pos_type bp
	                        	left join(
	                        		SELECT
	                        			date,
	                        			sum(amount) over (order by date) as cum_sum
	                        		 FROM (
	                        		 	SELECT
	                        		 		DATE_TRUNC('month', open_date) AS date,
	                        		        count(distinct pos_id) as amount
	                        		    FROM oplati_analytic.spr_pos_area
	                        		    group by date
	                        		 ) AS t
	                        	) t2
	                        	on DATE_TRUNC('month', created_date)=t2.date where bp.status =1
	                        	GROUP BY DATE_TRUNC('month', created_date), cum_sum, type_name
	                        ) AS virtual_table
	                        WHERE DATE_TRUNC('month', date) = DATE_TRUNC('month', today())
	                        GROUP BY type_name
	                        ORDER BY mme_inner__ DESC
	                        LIMIT 100
                        ) AS anon_1 ON type_name = type_name__
                        WHERE DATE_TRUNC('month', date) = DATE_TRUNC('month', today())
                        GROUP BY type_name, date
                        ORDER BY amount_act desc;"

  "tab_bi_activity_org_monthly_type":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_activity_org_monthly_type
    datetime_field: date
    recount_period: month
    remove_current: remove
    clickhouse_query: "insert into oplati_views_report.bi_activity_org_monthly_type
                        select
	                        DATE_TRUNC('month', date) AS date,
	                        type_name AS type_name,
	                        sum(active) AS amount_act
                        FROM (
	                        SELECT
	                        	DATE_TRUNC('month', trans_date) AS date,
	                        	type_name,
	                        	count(DISTINCT itn) as active,
	                        	cum_sum
	                        FROM oplati_analytic.bi_transactions_org_out bt
	                        left join (
		                        SELECT
		                        	date,
		                        	sum(amount) over (order by date) as cum_sum
		                        from (
			                        SELECT
				                        DATE_TRUNC('month', date_create) AS date,
			                            count (distinct profile_id) as amount
			                        FROM oplati_analytic.bi_organisation
			                        group by date
		                        ) t
	                        ) t2
	                        on DATE_TRUNC('month', trans_date)=t2.date
	                        GROUP BY date, cum_sum, type_name
                        ) AS virtual_table

                        JOIN (
	                        SELECT
	                        	type_name AS type_name__,
	                        	sum(active) AS mme_inner__
	                        FROM (
		                        SELECT
			                        DATE_TRUNC('month', trans_date) AS date,
			                        type_name,
			                        count(DISTINCT itn) as active,
			                        cum_sum
		                        FROM oplati_analytic.bi_transactions_org_out bt
		                        left join (
			                        SELECT
			                        	date,
			                        	sum(amount) over (order by date) as cum_sum
			                        from (
				                        SELECT
					                        DATE_TRUNC('month', date_create) AS date,
			                                count (distinct profile_id) as amount
			                            FROM oplati_analytic.bi_organisation
			                            group by date
			                        ) t
		                        ) t2
		                        on DATE_TRUNC('month', trans_date)=t2.date
		                        GROUP BY date, cum_sum, type_name
	                        ) AS virtual_table
	                        WHERE DATE_TRUNC('month', date) = DATE_TRUNC('month', today())
	                        GROUP BY type_name
	                        ORDER BY mme_inner__ DESC
	                        LIMIT 100
                        ) AS anon_1 ON type_name = type_name__
                        WHERE DATE_TRUNC('month', date) = DATE_TRUNC('month', today())
                        GROUP BY type_name, date
                        ORDER BY amount_act desc;"

  "tab_bi_activity_cash_monthly_type":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_activity_cash_monthly_type
    datetime_field: date
    recount_period: month
    remove_current: remove
    clickhouse_query: "insert into oplati_views_report.bi_activity_cash_monthly_type 
                        SELECT 
                        	DATE_TRUNC('month', date) AS date,
                        	type_name AS type_name,
                        	sum(active) AS amount_act
                        FROM (
                        	SELECT
                        		DATE_TRUNC('month', created_date) AS date,
                        		type_name,
                        		count(DISTINCT device_id) as active
                        	FROM oplati_analytic.bi_pos_type
                        	left join (
                        		select
                        			date,
                        			sum(amount) over (order by date) as cum_sum
                        		from (
                        			SELECT
                        				DATE_TRUNC('month', open_date) AS date,
                        			    count(distinct cash_id) as amount
                        			FROM oplati_analytic.spr_cashbox_area
                        			where close_date is NULL
                        			group by date
                        		) t
                        	) t2
                        	on DATE_TRUNC('month', created_date)=t2.date where status = 1
                        	GROUP BY date, cum_sum, type_name
                        ) AS virtual_table
                        
                        JOIN (
                        	SELECT
                        		type_name AS type_name__,
                        		sum(active) AS mme_inner__
                        	FROM (
                        		SELECT
                        			DATE_TRUNC('month', created_date) AS date,
                        			type_name,
                        			count(DISTINCT device_id) as active,
                        			cum_sum
                        		FROM oplati_analytic.bi_pos_type
                        		left join (
                        			select
                        				date,
                        				sum(amount) over (order by date) as cum_sum
                        			from (
                        				SELECT
                        					DATE_TRUNC('month', open_date) AS date,
                        			        count(distinct cash_id) as amount
                        			    FROM oplati_analytic.spr_cashbox_area
                        			    where close_date is NULL
                        			    group by date
                        			) t
                        		) t2
                        		on DATE_TRUNC('month', created_date)=t2.date where status = 1
                        		GROUP BY date, cum_sum, type_name
                        	) AS virtual_table
                        	WHERE DATE_TRUNC('month', date) = DATE_TRUNC('month', today())
                        	GROUP BY type_name
                        	ORDER BY mme_inner__ DESC
                        	LIMIT 100
                        ) AS anon_1
                        ON type_name = type_name__
                        WHERE DATE_TRUNC('month', date) = DATE_TRUNC('month', today())
                        GROUP BY type_name, date
                        ORDER BY amount_act desc;"

  "tab_bi_agr_direction_azs_act_cash":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_azs_act_cash
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_azs_act_cash
                        SELECT
	                        today()-1 as report_date,
	                        name AS name,
                            itn AS itn,
                            pos_name AS pos_name,
                            type_name AS type_name,   
                            sum(CASE WHEN created_date >= toDate(today()) - 1 AND created_date < today() THEN 1 ELSE 0 END) AS amount_prev_day,
                               case
                                   when sum(sum) filter (where created_date >= today() - 1 and created_date < today()) is NULL then 0
                                   else sum(sum) filter (where created_date >= today() - 1 and created_date < today())
                               end AS sum_prev_day,
                            sum(CASE WHEN created_date >= toDate(today()) - 7 AND created_date < today() THEN 1 ELSE 0 END) AS amount_7_day,
                            case
                            	when sum(sum) filter (where created_date >= today() - 7 and created_date < today()) is NULL then 0
                                else sum(sum) filter (where created_date >= today() - 7 and created_date < today())
                            end AS sum_7_day,
                            sum(CASE WHEN created_date >= date_trunc('month', today() - INTERVAL 1 MONTH) and created_date < date_trunc('month', today()) THEN 1 ELSE 0 END) AS amount_prev_month,
                            case
                            	when sum(sum) filter (where created_date>=date_trunc('month', today() - INTERVAL 1 MONTH) and created_date<date_trunc('month', today())) is NULL then 0
                                else sum(sum) filter (where created_date>=date_trunc('month', today() - INTERVAL 1 MONTH) and created_date<date_trunc('month', today()))
                            end AS sum_prev_month,
                            count(purchase_id) AS total_amount,
                            SUM(sum) AS total_sum
                        FROM (
	                        select *
   	                        from oplati_analytic.bi_pos_type_2023 bpt
   	                        where itn in ('400051902', '100341433', '690362737', '191112998', '100126124')
                             and (device_id in (6495, 13097, 14712, 59901) or cashbox_type=1)
                             and bpt.status=1
                        ) AS virtual_table
                        WHERE ((device_id not in (6495, 13097, 14712, 59901)))
                        GROUP BY name, itn, pos_name, type_name
                        ORDER BY sum(sum) desc;"

  "tab_bi_agr_direction_catalog_inact_cash":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_catalog_inact_cash
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_catalog_inact_cash
                        select  
	                        today()-1 as report_date,
	                        bop.name as ul_name,
	                        bop.itn,
	                        bop.type_name as category_name,
	                        pos_name,
	                        cashbox_number
                        from oplati_analytic.spr_cashbox_area sca 
                        join oplati_analytic.spr_poi_app_channels spac on spac.cashbox_number=sca.reg_num
                        left join oplati_analytic.spr_poi_app spa on spac.app_id=spa.id
                        left join oplati_analytic.spr_poi_app_category t1 on t1.id=spa.category_id
                        left join oplati_analytic.spr_pos_area spa2 on spa2.pos_id  = sca.pos_id
                        left join oplati_analytic.bi_organisation_payments bop on spa2.org_id  = bop.org_id
                        where spa.name is not null and sca.cash_id  not in (select distinct device_id from oplati_analytic.bi_pos_type bpt);"

  "tab_bi_agr_direction_entertainment_inact_cash":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_entertainment_inact_cash
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_entertainment_inact_cash
                        select  
	                        today() - 1 as report_date,
  	                        bop.name AS name,
                            bop.itn AS itn,
                            bop.type_name AS type_name,
                            spa.pos_name AS pos_name,
                            a.reg_num AS reg_num,
                            'Total' as type_group
                        from oplati_analytic.spr_entertainment_point p
                        left join oplati_analytic.spr_entertainment_zone z on p.id = z.object_id
                        left join oplati_analytic.spr_cashbox_area a on p.cash_id = a.cash_id
                        left join oplati_analytic.spr_pos_area spa on a.pos_id = spa.pos_id
                        left join oplati_analytic.bi_organisation_payments bop on bop.org_id = spa.org_id
                        where a.close_date is null and p.cash_id not in (select distinct device_id from oplati_analytic.bi_pos_type)
                        GROUP BY bop.name, bop.itn, bop.type_name, spa.pos_name, a.reg_num
   
                        union all 

                        select  
	                        today() - 1 as report_date,
  	                        bop.name AS name,
                            bop.itn AS itn,
                            bop.type_name AS type_name,
                            spa.pos_name AS pos_name,
                            a.reg_num AS reg_num,
                            'Other' as type_group
                        from oplati_analytic.spr_entertainment_point p
                        left join oplati_analytic.spr_entertainment_zone z on p.id=z.object_id
                        left join oplati_analytic.spr_cashbox_area a on p.cash_id =a.cash_id
                        left join oplati_analytic.spr_pos_area spa on a.pos_id=spa.pos_id
                        left join oplati_analytic.bi_organisation_payments bop on bop.org_id =spa.org_id
                        where bop.itn = '100193541' and a.close_date is null and p.cash_id not in (select distinct device_id from oplati_analytic.bi_pos_type)
                        GROUP BY bop.name, bop.itn, bop.type_name, spa.pos_name, a.reg_num;"

  "tab_bi_agr_direction_integrated_site_inact_cash":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_integrated_site_inact_cash
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_integrated_site_inact_cash
                        select
	                        today()-1 as report_date,
	                        bop.\"name\" as \"name\",
	                        bop.itn as itn,
	                        bop.type_name as type_name,
	                        pos_name,
	                        reg_num
                        from (
	                        select * from (
		                        select
			                        bop.\"name\",
			                        bop.itn,
			                        bop.type_name,
			                        pos_name,
			                        reg_num,
			                        cash_id
		                        from oplati_analytic.bi_organisation_payments bop 
		                        left join oplati_analytic.spr_pos_area spa
		                        on bop.org_id =spa.org_id 
		                        left join oplati_analytic.spr_cashbox_area sca
		                        on sca.pos_id=spa.pos_id
		                        where  bop.org_id not in (
			                        613278,311490,73670,134259,615279, 141122,155007,168413,173531,218394,
			                        223318,228876,233174,233184,235296,237365,240479,244250,244253,245985,
			                        249123,249921,253424,253475,254145,257255,257324,257684,257869,260198,
			                        260230,261349,264486,268937,269657,271762,272622,275136,277032,282822,
			                        283466,289171,289206,293619,296201,297026,299674,299721,302694,302704,
			                        306193,307979,310841,311310,312584,316047,320383,321239,331515,333889,
			                        333895,333933,340333,347507,347563,352317,355739,355844,357260,357276,
			                        361937,366062,367586,370160,370813,373117,373121,373653,373792,373813,
			                        374354,374500,378586,379133,379143,380597,382895,386232,388455,389687,
			                        390667,393363,420876,429226,429267,436599,457863,460856,464337,465095,
			                        486361,511141,517442,519131,525118,526305,534824,539022,54305,544949,
			                        546538,552659,552989,557715,557971,574266,605268,606533,622793,631426,
			                        633700,634415,646060,647029,652950,653266,653274,656376,657019,657992,
			                        659001,659009,659676,663924,664652,668843,669094,684326,684518,701745,77790)
		                        and sca.cashbox_type=3 
		                        and type_name not in ('Пассажирские перевозки','Вендинговые аппараты', 'АЗС', 'Водоматы', 'Автомойки')
		                        and itn <>'192812526' and itn<>'100993744'
		                        and itn<>'193009535' and itn<>'102391623'
		                        and sca.cash_id<>6112 and sca.cash_id<>9411
		                        and sca.close_date is null
	                        ) ddd
	                        left join oplati_analytic.spr_poi_app_channels ttt
	                        on ddd.reg_num = ttt.cashbox_number 
	                        where ttt.id = 0
                        )ff
                        where cash_id not in (select distinct device_id from oplati_analytic.bi_pos_type bpt);"

  "tab_bi_agr_direction_vending":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_vending
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_vending 
                        SELECT 
	                        today() - 1 as report_date,
	                        bpt.name AS name,
                            bpt.itn AS itn,
                            pos_name AS pos_name,
                            bop.type_name AS type_name,
                            imei,
                            sum(CASE WHEN created_date >= toDate(today()) - 1 AND created_date < today() THEN 1 ELSE 0 END) AS amount_prev_day,
                            case
    	                        when sum(sum) filter (where created_date >= today() - 1 and created_date < today()) is NULL then 0
                                else sum(sum) filter (where created_date >= today() - 1 and created_date < today())
                            end AS sum_prev_day,
                            sum(CASE WHEN created_date >= toDate(today()) - 7 AND created_date < today() THEN 1 ELSE 0 END) AS amount_7_day,
                            case
    	                        when sum(sum) filter (where created_date >= today() - 7 and created_date < today()) is NULL then 0
                                else sum(sum) filter (where created_date >= today() - 7 and created_date < today())
                            end AS sum_7_day,
                            sum(CASE WHEN created_date >= date_trunc('month', today() - INTERVAL 1 MONTH) and created_date < date_trunc('month', today()) THEN 1 ELSE 0 END) AS amount_prev_month,
                            case
    	                        when sum(sum) filter (where created_date>=date_trunc('month', today() - INTERVAL 1 MONTH) and created_date<date_trunc('month', today())) is NULL then 0
                                else sum(sum) filter (where created_date>=date_trunc('month', today() - INTERVAL 1 MONTH) and created_date<date_trunc('month', today()))
                            end AS sum_prev_month,
                            count(purchase_id) AS total_amount,
                            SUM(sum) AS total_sum
                        from oplati_analytic.bi_pos_type_2023 bpt
                        left join oplati_analytic.spr_water_machine sc on bpt.device_id=sc.cashbox_id 
                        left join oplati_analytic.spr_wending_machine scs on bpt.device_id=scs.cash_id 
                        left join oplati_analytic.bi_organisation_payments bop on bpt.itn=bop.itn
                        where bpt.type_name in ('Вендинговые аппараты','Водоматы') and bpt.status=1 and bpt.itn IS NOT NULL
                        GROUP BY bpt.name, bpt.itn, pos_name, bop.type_name, imei
                        ORDER BY sum(bpt.sum) desc;"

  "tab_bi_agr_direction_catalog":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_catalog
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_catalog
                        select
	                        report_date,
	                        company_name,
	                        itn,
	                        bo.name as category_name,
	                        cat_tot.\"name\",
	                        amount_prev_day,
	                        sum_prev_day,
	                        amount_7_day,
	                        sum_7_day,
	                        amount_prev_month,
	                        sum_prev_month,
	                        total_amount,
	                        total_sum
                        from (
                        	SELECT 
                            	today() - 1 as report_date,
                        	   	bpt.name AS company_name,
                               	bpt.itn AS itn,
                               	sca.name as \"name\",
                              	sum(CASE WHEN created_date >= toDate(today()) - 1 AND created_date < today() THEN 1 ELSE 0 END) AS amount_prev_day,
                            	case
                            		when sum(sum) filter (where created_date >= today() - 1 and created_date < today()) is NULL then 0
                                	else sum(sum) filter (where created_date >= today() - 1 and created_date < today())
                            	end AS sum_prev_day,
                               	sum(CASE WHEN created_date >= toDate(today()) - 7 AND created_date < today() THEN 1 ELSE 0 END) AS amount_7_day,
                            	case
                            		when sum(sum) filter (where created_date >= today() - 7 and created_date < today()) is NULL then 0
                                	else sum(sum) filter (where created_date >= today() - 7 and created_date < today())
                            	end AS sum_7_day,
                               	sum(CASE WHEN created_date >= date_trunc('month', today() - INTERVAL 1 MONTH) and created_date < date_trunc('month', today()) THEN 1 ELSE 0 END) AS amount_prev_month,
                            	case
                            		when sum(sum) filter (where created_date>=date_trunc('month', today() - INTERVAL 1 MONTH) and created_date<date_trunc('month', today())) is NULL then 0
                                	else sum(sum) filter (where created_date>=date_trunc('month', today() - INTERVAL 1 MONTH) and created_date<date_trunc('month', today()))
                            	end AS sum_prev_month,
                               	count(purchase_id) AS total_amount,
                            	SUM(sum) AS total_sum
                            from oplati_analytic.bi_pos_type bpt
                            left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
                            left join oplati_analytic.spr_poi_app_channels spac on spac.cashbox_number=sca.reg_num
                            left join oplati_analytic.spr_poi_app spa on spac.app_id=spa.id
                            left join oplati_analytic.spr_poi_app_category t1 on t1.id=spa.category_id
                            where spa.name is not null and bpt.status = 1
                            group by bpt.name, bpt.itn, sca.name
                        ) as cat_tot
                        left join oplati_analytic.bi_organisation bo 
                        on bo.unp  = cat_tot.itn;"

  "tab_bi_agr_entertainment_daily":
    clickhouse_query: "insert into oplati_views_report.bi_agr_entertainment_daily
                         SELECT 
 	                        DATE_TRUNC('day', buy_date) AS report_date,
 	                        count(distinct id) AS amount_operation,
	                        count(distinct profile_id) AS amount_customers,
	                        count(DISTINCT CASE WHEN company_id = 754023 THEN id END) AS avg_check_id,
                            count(DISTINCT CASE WHEN company_id = 754023 THEN profile_id END) AS avg_check_profile_id
                        FROM oplati_analytic.bi_entertainment_ticket
                        where  ((status = 'BUY') and  buy_date::date = today()-1)
                        GROUP BY DATE_TRUNC('day', buy_date)
                        ORDER BY report_date desc;"

  "tab_bi_agr_entertainment_monthly":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_entertainment_monthly
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_entertainment_monthly 
                        select 
                        	ent_sum.report_date,
                        	ent_n_cash.new_cashbox,
                        	avg_check,
                        	total_turnover,
                        	ent_n_cash.other_new_cashbox,
                        	other_avg_check,
                        	other_total_turnover
                        from (
                         SELECT 
                         	DATE_TRUNC('month', buy_date) AS report_date,
                        	round(avg(price),2) AS avg_check,
                        	count(DISTINCT id) * round(avg(price),2) AS total_turnover,
                        	round(avg(price) filter (where company_id = 754023),2)  AS other_avg_check,
                        	count(DISTINCT id) filter (where company_id = 754023) * round(avg(price) filter (where company_id = 754023),2) AS other_total_turnover
                        FROM oplati_analytic.bi_entertainment_ticket
                        where ((status = 'BUY') and DATE_TRUNC('month', buy_date) = DATE_TRUNC('month', today() - 1))
                        GROUP BY DATE_TRUNC('month', buy_date)
                        ORDER BY report_date DESC
                        ) ent_sum

                        left join (
                        	select 
                        		DATE_TRUNC('month', a.open_date) AS report_date,
                            	count(DISTINCT p.cash_id) AS new_cashbox,
                            	count(DISTINCT p.cash_id) filter (where bop.itn = '100193541') AS other_new_cashbox
                        	from oplati_analytic.spr_entertainment_point p
                        	left join oplati_analytic.spr_entertainment_zone z on p.id=z.object_id
                        	left join oplati_analytic.spr_cashbox_area a on p.cash_id =a.cash_id
                        	left join oplati_analytic.spr_pos_area spa on a.pos_id=spa.pos_id
                        	left join oplati_analytic.bi_organisation_payments bop on bop.org_id =spa.org_id
                        	where a.close_date is null and DATE_TRUNC('month', a.open_date) = DATE_TRUNC('month', today() - 1)
                        	group by DATE_TRUNC('month', a.open_date) 
                        )ent_n_cash 
                        on ent_n_cash.report_date = ent_sum.report_date
                        order by report_date asc;"

  "tab_bi_agr_vending_daily":
    clickhouse_query: "insert into oplati_views_report.bi_agr_vending_daily
                        select 
	                        t_v.report_date,
	                        total_sum_operation,
	                        vodom_amount_cashbox+vend_amount_cashbox as total_amount_cashbox,
	                        vodomat_sum_operation,
	                        vodom_amount_cashbox,
	                        vending_sum_operation,
	                        vend_amount_cashbox
                        from (
	                        select
	                        	DATE_TRUNC('day', created_date) AS report_date,
	                        	count(*) AS total_sum_operation,
	                        	count(CASE WHEN type_name = 'Водоматы' THEN 1 ELSE NULL END) AS vodomat_sum_operation,
	                        	count(CASE WHEN type_name = 'Вендинговые аппараты' THEN 1 ELSE NULL END) AS vending_sum_operation
	                        from oplati_analytic.bi_pos_type_2023 bpt
	                        where 
	                        	type_name in ('Вендинговые аппараты','Водоматы') and
	                        	status=1 and
	                        	created_date :: date = today()-1
	                        group by DATE_TRUNC('day', created_date)
                        )t_v

                        left join (
                        	select 
                        		today() - 1 as report_date,
                        		count(*) as vodom_amount_cashbox
                        	from oplati_analytic.spr_cashbox_area sca 
                        	where cash_id in (select distinct cashbox_id from oplati_analytic.spr_water_machine) and 
                        	sca.open_date::date = today() - 1
                        )t_wot
                        on t_v.report_date = t_wot.report_date

                        left join (
                        	select 
                        		today() - 1 as report_date,
                        		count(*) as vend_amount_cashbox
                        	from oplati_analytic.spr_cashbox_area sca 
                        	where cash_id in (select distinct cash_id from  oplati_analytic.spr_wending_machine swm) and 
                        	sca.open_date::date = today()-1
                        )t_vend
                        on t_v.report_date = t_vend.report_date;"

  "tab_bi_agr_vending_monthly":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_vending_monthly
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_vending_monthly
                        select
                            date_trunc('month', created_date) AS report_date,
                        	round(avg(sum), 2) AS total_avg_check,
                        	round(count(distinct profile_id), 2) total_amount_customers,
                        	round(sum(sum), 2) total_turnover,
                        
                        	round(avg(sum) filter (where type_name = 'Водоматы'), 2) AS vodom_avg_check,
                        	round(count(distinct profile_id) filter (where type_name = 'Водоматы'), 2) vodom_amount_customers,
                        	round(sum(sum) filter (where type_name = 'Водоматы'), 2) vodom_turnover,
                        	
                        	round(avg(sum) filter (where type_name = 'Вендинговые аппараты'), 2) AS vend_avg_check,
                        	round(count(distinct profile_id) filter (where type_name = 'Вендинговые аппараты'), 2) vend_amount_customers,
                        	round(sum(sum) filter (where type_name = 'Вендинговые аппараты'), 2) vend_turnover
                        	
                        from oplati_analytic.bi_pos_type_2023 bpt
                        where
                        	type_name in ('Вендинговые аппараты','Водоматы') and
                        	status=1 and
                        	DATE_TRUNC('month', bpt.created_date) = DATE_TRUNC('month', today() - 1)
                        group by DATE_TRUNC('month', created_date);"

  "tab_bi_agr_ticket_pupulation":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_ticket_pupulation
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_ticket_pupulation
                        SELECT 
                            report_date,
                            autopark_city,
                            population,
                            amount_tickets_year,
                            active_customers_year,
                            active_customers_year / population AS active_customers_perc
                        FROM (
                            SELECT 
                                today() - 1 as report_date,
                                autopark_city AS autopark_city,
                                sum(population) AS population,
                                sum(tickets) AS amount_tickets_year,
                                sum(active) AS active_customers_year
                            FROM (
	                            SELECT
		                            autopark_city,
                                    count(distinct profile_id) filter (where date_time >= date(today()) - interval '1 year' and date_time < date(today())) as active,
                                    count(distinct id) filter (where date_time >= date(today()) - interval '1 year' and date_time < date(today())) as tickets,
                                    case
                                        when autopark_city='Гомель' then 508000
                                        when autopark_city='Витебск' then 363000
                                        when autopark_city='Могилев' then 357404
                                        when autopark_city='Гродно' then 358000
                                        when autopark_city='Брест' then 340000
                                        when autopark_city='Бобруйск' then 211000
                                        when autopark_city='Барановичи' then 174000
                                        when autopark_city='Борисов' then 140700
                                        when autopark_city='Пинск' then 126000
                                        when autopark_city='Орша' then 116000
                                        when autopark_city='Мозырь' then 111000
                                        when autopark_city='Солигорск' then 105000
                                        when autopark_city='Лида' then 103000
                                        when autopark_city='Новополоцк' then 98000
                                        when autopark_city='Молодечно' then 93000
                                        when autopark_city='Полоцк' then 84000
                                        when autopark_city='Жлобин' then 76000
                                        when autopark_city='Светлогорск' then 69000
                                        when autopark_city='Речица' then 65000
                                        when autopark_city='Жодино' then 65000
                                        when autopark_city='Слуцк' then 61000
                                        when autopark_city='Кобрин' then 52000
                                        when autopark_city='Слоним' then 49000
                                        when autopark_city='Волковыск' then 43000
                                        when autopark_city='Калинковичи' then 39000
                                        when autopark_city='Рогачев' then 34000
                                        when autopark_city='Осиповичи' then 31000
                                        when autopark_city='Горки' then 31000
                                        when autopark_city='Новогрудок' then 29000
                                        when autopark_city='Береза' then 29000
                                        when autopark_city='Вилейка' then 26000
                                        when autopark_city='Кричев' then 26000
                                        when autopark_city='Дзержинск' then 26000
                                        when autopark_city='Лунинец' then 24000
                                        when autopark_city='Марьина Горка' then 21000
                                        when autopark_city='Добруш' then 18000
                                        when autopark_city='Житковичи' then 16000
                                        when autopark_city='Копыль' then 9000
                                        when autopark_city='Лельчицы' then 11000
                                        when autopark_city='Ратомка' then 5000
                                        when autopark_city='Наровля' then 8000
                                        when autopark_city='Хойники' then 13000
                                        when autopark_city='Сморгонь' then 36000
                                        when autopark_city='Хатежино' then 2000
                                        when autopark_city='Лепель' then 17000
                                        when autopark_city='Иваново' then 16000
                                        when autopark_city='Шклов' then 16000
                                        when autopark_city='Столбцы' then 16000
                                        when autopark_city='Ошмяны' then 15000
                                        when autopark_city='Смолевичи' then 15000
                                        when autopark_city='Щучин' then 15000
                                        when autopark_city='Несвиж' then 14000
                                        when autopark_city='Ганцевичи' then 13000
                                        when autopark_city='Березино' then 11000
                                        when autopark_city='Логойск' then 11000
                                        when autopark_city='Любань' then 11000
                                        when autopark_city='Клецк' then 11000
                                        when autopark_city='Березовка' then 10000
                                        when autopark_city='Воложин' then 10000
                                        when autopark_city='Петриков' then 10000
                                        when autopark_city='Толочин' then 10000
                                        when autopark_city='Червень' then 10000
                                        when autopark_city='Браслав' then 9000
                                        when autopark_city='Ельск' then 9000
                                        when autopark_city='Крупки' then 9000
                                        when autopark_city='Юзуфово' then 15000
                                        when autopark_city='Минский р-н, пос.Ратомка' then 4850
                                        when autopark_city='Лепельский р-н, д.Заслоново' then 2000
                                        when autopark_city='Боровляны' then 40000
                                        when autopark_city='Микашевичи' then 12395
                                        when autopark_city='Пружаны' then 19000
                                        when autopark_city='Поставы' then 18618
                                        when autopark_city='Жабинка' then 14418
                                        when autopark_city='Лоев' then 6103
                                        when autopark_city='Малорита' then 12735
                                        when autopark_city='Заславль' then 17404
                                        else 1
                                      end as population
                                FROM oplati_analytic.bi_tickets
                                group by autopark_city, population
                            ) AS virtual_table
                            WHERE autopark_city != 'Минск'
                            GROUP BY autopark_city
                        ) AS final_results
                        ORDER BY population DESC;"

  "tab_bi_agr_ticket_city":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_ticket_city
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_ticket_city
                        select 
	                        bt.report_date,
	                        bt.autopark_city,
	                        bt.amount_tickets,
	                        bt.unic_customers,
	                        bt.amount_tickets_not_minibus,
	                        case when bt.amount_tickets_minibus = 0 then null else bt.amount_tickets_minibus end as amount_tickets_minibus,
	                        btrav.amount_travel_card 
                        from (
	                        select 
	                        	date_trunc('month',date_time) as report_date,
	                        	autopark_city ,
	                        	count(*) as amount_tickets,
	                        	count(distinct profile_id) as unic_customers,
	                        	count(DISTINCT id) filter (where vehicle_type != 'Маршрутное такси') AS amount_tickets_not_minibus,
	                        	count(DISTINCT id) filter (where vehicle_type = 'Маршрутное такси') AS amount_tickets_minibus
	                        FROM oplati_analytic.bi_tickets_customer 
	                        WHERE status = 1 and date_trunc('month',date_time) = date_trunc('month',today()-1)
	                        group by date_trunc('month',date_time),autopark_city
                        ) bt
                        full join (
	                        SELECT
	                        	DATE_TRUNC('month', date_time) AS date_time,
                               	autopark_city AS autopark_city,
                               	count(DISTINCT id) AS amount_travel_card
	                        FROM oplati_analytic.bi_travel_card
	                        WHERE date_trunc('month',date_time) = date_trunc('month',today()-1)
	                        GROUP BY date_time, autopark_city
                        ) btrav
                        on btrav.date_time::date = bt.report_date::date and btrav.autopark_city= bt.autopark_city
                        order by bt.report_date desc;"

  "tab_bi_agr_azs_daily":
    clickhouse_query: "insert into oplati_views_report.bi_agr_azs_daily 
                        select 
	                        date_trunc('day',created_date)  as report_date,
	                        CASE WHEN sum(sum) filter (where itn='690362737') IS NULL THEN 0 ELSE sum(sum) filter (where itn='690362737') END as sum_a_100,
	                        CASE WHEN sum(sum) filter (where itn='100341433') IS NULL THEN 0 ELSE sum(sum) filter (where itn='100341433') END as sum_united_company,
	                        CASE WHEN sum(sum) filter (where itn='400051902') IS NULL THEN 0 ELSE sum(sum) filter (where itn='400051902') END as sum_belorusneft,
	
	                        CASE WHEN count(DISTINCT poi) filter (where itn='690362737') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='690362737') END as active_a_100,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='100341433') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='100341433') END as active_united_company,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='400051902') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='400051902') END as active_belorusneft,

	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='690362737') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='690362737') END as active_customers_a_100,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100341433') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100341433') END as active_customers_united_company,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='400051902') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='400051902') END as active_customers_belorusneft,

	                        CASE WHEN sum(sum) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))) END as sum_trk_a_100,
	                        CASE WHEN sum(sum) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))) END as sum_trk_united_company,
	                        CASE WHEN sum(sum) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))) END as sum_trk_belorusneft,

	                        CASE WHEN count(DISTINCT poi) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='690362737' and (device_id  in (6495, 13097, 14712, 59901))) END as active_trk_a_100,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='100341433' and (device_id  in (6495, 13097, 14712, 59901))) END as active_trk_united_company,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='400051902' and (device_id  in (6495, 13097, 14712, 59901))) END as active_trk_belorusneft,
	
	                        CASE WHEN sum(sum) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as sum_to_a_100,
	                        CASE WHEN sum(sum) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as sum_to_united_company,
	                        CASE WHEN sum(sum) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as sum_to_belorusneft,
	
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as active_to_a_100,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as active_to_united_company,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as active_to_belorusneft,
	
	                        CASE WHEN count(distinct purchase_id) filter (where itn='690362737' and (device_id  in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='690362737' and (device_id  in (6495, 13097, 14712, 59901))) END as operation_trk_a_100,
	                        CASE WHEN count(distinct purchase_id) filter (where itn='100341433' and (device_id  in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='100341433' and (device_id  in (6495, 13097, 14712, 59901))) END as operation_trk_united_company,
	                        CASE WHEN count(distinct purchase_id) filter (where itn='400051902' and (device_id  in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='400051902' and (device_id  in (6495, 13097, 14712, 59901))) END as operation_trk_belorusneft,

	                        CASE WHEN count(distinct purchase_id) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as operation_to_a_100,
	                        CASE WHEN count(distinct purchase_id) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as operation_to_united_company,
	                        CASE WHEN count(distinct purchase_id) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as operation_to_belorusneft,

	                        CASE WHEN sum(sum) filter (where itn='191112998') IS NULL THEN 0 ELSE sum(sum) filter (where itn='191112998') END as sum_tatneft,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='191112998') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='191112998') END as active_tatneft,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='191112998') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='191112998') END as active_customers_tatneft,
	                        CASE WHEN sum(sum) filter (where itn='191112998' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='191112998' and (device_id in (6495, 13097, 14712, 59901))) END as sum_trk_tatneft,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) END as active_trk_tatneft,
	                        CASE WHEN sum(sum) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901)  or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901)  or cashbox_type=1)) END as sum_to_tatneft,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as active_to_tatneft,
	                        CASE WHEN count(distinct purchase_id) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) END as operation_trk_tatneft,
	                        CASE WHEN count(distinct purchase_id) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as operation_to_tatneft,

	                        CASE WHEN sum(sum) filter (where itn='100126124') IS NULL THEN 0 ELSE sum(sum) filter (where itn='100126124') END as sum_lukoil,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='100126124') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='100126124') END as active_lukoil,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100126124') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100126124') END as active_customers_lukoil,
	                        CASE WHEN sum(sum) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) END as sum_trk_lukoil,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) END as active_trk_lukoil,
	                        CASE WHEN sum(sum) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as sum_to_lukoil,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as active_to_lukoil,
	                        CASE WHEN count(distinct purchase_id) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) END as operation_trk_lukoil,
	                        CASE WHEN count(distinct purchase_id) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(distinct purchase_id) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as operation_to_lukoil
	
                        from oplati_analytic.bi_pos_type_2023 bpt
                        where 
	                        itn in ('400051902','100341433','690362737','191112998','100126124') and 
	                        (device_id in (6495, 13097, 14712, 59901) or cashbox_type=1) and 
	                        bpt.status=1 and created_date::date = today() - 1
                        group by date_trunc('day',created_date)
                        order by report_date asc;"

  "tab_bi_agr_azs_monthly":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_azs_monthly
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_azs_monthly 
                        select 
	                        date_trunc('month',created_date)  as report_date,
	                        CASE WHEN sum(sum) filter (where itn='690362737') IS NULL THEN 0 ELSE sum(sum) filter (where itn='690362737') END as sum_a_100,
	                        CASE WHEN sum(sum) filter (where itn='100341433') IS NULL THEN 0 ELSE sum(sum) filter (where itn='100341433') END as sum_united_company,
	                        CASE WHEN sum(sum) filter (where itn='400051902') IS NULL THEN 0 ELSE sum(sum) filter (where itn='400051902') END as sum_belorusneft,
	
	                        CASE WHEN count(DISTINCT poi) filter (where itn='690362737') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='690362737') END as active_a_100,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='100341433') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='100341433') END as active_united_company,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='400051902') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='400051902') END as active_belorusneft,

	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='690362737') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='690362737') END as active_customers_a_100,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100341433') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100341433') END as active_customers_united_company,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='400051902') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='400051902') END as active_customers_belorusneft,

	                        CASE WHEN sum(sum) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))) END as sum_trk_a_100,
	                        CASE WHEN sum(sum) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))) END as sum_trk_united_company,
	                        CASE WHEN sum(sum) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))) END as sum_trk_belorusneft,

	                        CASE WHEN count(DISTINCT poi) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='690362737' and (device_id  in (6495, 13097, 14712, 59901))) END as active_trk_a_100,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='100341433' and (device_id  in (6495, 13097, 14712, 59901))) END as active_trk_united_company,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='400051902' and (device_id  in (6495, 13097, 14712, 59901))) END as active_trk_belorusneft,
	
	                        CASE WHEN sum(sum) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as sum_to_a_100,
	                        CASE WHEN sum(sum) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as sum_to_united_company,
	                        CASE WHEN sum(sum) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as sum_to_belorusneft,
	
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as customers_to_a_100,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as customers_to_united_company,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as customers_to_belorusneft,
	
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))) END as customers_trk_a_100,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))) END as customers_trk_united_company,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))) END as customers_trk_belorusneft,
	
	                        CASE WHEN round(avg(sum) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='690362737' and (device_id in (6495, 13097, 14712, 59901))), 2) END as avg_check_trk_a_100,
	                        CASE WHEN round(avg(sum) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='100341433' and (device_id in (6495, 13097, 14712, 59901))), 2) END as avg_check_trk_united_company,
	                        CASE WHEN round(avg(sum) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='400051902' and (device_id in (6495, 13097, 14712, 59901))), 2) END as avg_check_trk_belorusneft,
	
	                        CASE WHEN round(avg(sum) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='690362737' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) END as avg_check_to_a_100,
	                        CASE WHEN round(avg(sum) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='100341433' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) END as avg_check_to_united_company,
	                        CASE WHEN round(avg(sum) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='400051902' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) END as avg_check_to_belorusneft,
	
	                        CASE WHEN sum(sum) filter (where itn='191112998') IS NULL THEN 0 ELSE sum(sum) filter (where itn='191112998') END as sum_tatneft,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='191112998') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='191112998') END as active_tatneft,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='191112998') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='191112998') END as active_customers_tatneft,
	                        CASE WHEN sum(sum) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) END as sum_trk_tatneft,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) END as active_trk_tatneft,
	                        CASE WHEN sum(sum) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as sum_to_tatneft,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as customers_to_tatneft,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))) END as customers_trk_tatneft,
	                        CASE WHEN round(avg(sum) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='191112998' and (device_id  in (6495, 13097, 14712, 59901))), 2) END as avg_check_trk_tatneft,
	                        CASE WHEN round(avg(sum) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='191112998' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) END as avg_check_to_tatneft,

	                        CASE WHEN sum(sum) filter (where itn='100126124') IS NULL THEN 0 ELSE sum(sum) filter (where itn='100126124') END as sum_lukoil,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='100126124') IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='100126124') END as active_lukoil,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100126124') IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100126124') END as active_customers_lukoil,
	                        CASE WHEN sum(sum) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE sum(sum) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) END as sum_trk_lukoil,
	                        CASE WHEN count(DISTINCT poi) filter (where itn='100126124' and (device_id  in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT poi) filter (where itn='100126124' and (device_id  in (6495, 13097, 14712, 59901))) END as active_trk_lukoil,
	                        CASE WHEN sum(sum) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE sum(sum) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as sum_to_lukoil,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)) END as customers_to_lukoil,
	                        CASE WHEN count(DISTINCT profile_id) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) IS NULL THEN 0 ELSE count(DISTINCT profile_id) filter (where itn='100126124' and (device_id in (6495, 13097, 14712, 59901))) END as customers_trk_lukoil,
	                        CASE WHEN round(avg(sum) filter (where itn='100126124' and (device_id  in (6495, 13097, 14712, 59901))), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='100126124' and (device_id  in (6495, 13097, 14712, 59901))), 2) END as avg_check_trk_lukoil,
	                        CASE WHEN round(avg(sum) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) IS NULL THEN 0 ELSE round(avg(sum) filter (where itn='100126124' and (device_id not in (6495, 13097, 14712, 59901) or cashbox_type=1)), 2) END as avg_check_to_lukoil
		
		
                        from oplati_analytic.bi_pos_type_2023 bpt
                        where 
                        	itn in ('400051902','100341433','690362737','191112998','100126124') and 
                        	(device_id in (6495, 13097, 14712, 59901) or cashbox_type=1) and 
                        	bpt.status=1 and  DATE_TRUNC('month', bpt.created_date) = DATE_TRUNC('month', today() - 1)
                        group by date_trunc('month',created_date)
                        order by report_date asc;"

  "tab_bi_agr_carwash_daily":
    clickhouse_query: "insert into oplati_views_report.bi_agr_carwash_daily
                        select
	                        amt.report_date,
	                        total_amount_operation,
	                        total_amount_cashbox
                        from (
	                        select 
		                        date_trunc('day',created_date) as report_date, 
		                        count(*) AS total_amount_operation,
		                        round(sum(sum), 2) AS carwash_active_cashbox
	                        from oplati_analytic.bi_pos_type_2023 bpt
	                        right join oplati_analytic.spr_carwash sc on bpt.device_id=sc.cash_id
	                        where sc.status='ACTIVE' and bpt.created_date::date = today() - 1
	                            and bpt.status=1
	                            and cash_id in (
		                            select distinct cash_id from oplati_analytic.spr_carwash where status='ACTIVE'
	                            )
	                        group by date_trunc('day',created_date)
                        ) amt

                        left join (
                            select
                                today() - 1 as report_date,
                                count(*) as total_amount_cashbox
                            from oplati_analytic.spr_cashbox_area sca 
                            where cash_id in (select distinct cash_id from oplati_analytic.spr_carwash where status='ACTIVE')
                                and sca.open_date::date = today()-1
                        ) bmt
                        on amt.report_date = bmt.report_date;"

  "tab_bi_agr_carwash_monthly":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_carwash_monthly
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_carwash_monthly
                        select 
	                        date_trunc('month',created_date) as report_date, 
	                        round(avg(sum), 2) AS avg_check,
	                        round(sum(sum), 2) AS total_turnover
                        from oplati_analytic.bi_pos_type_2023 bpt
                        right join oplati_analytic.spr_carwash sc
                        on bpt.device_id=sc.cash_id
                        where device_id in (
	                        select distinct cash_id
	                        from oplati_analytic.spr_carwash
	                        where status='ACTIVE'
	                        )
	                        and  DATE_TRUNC('month', bpt.created_date) = DATE_TRUNC('month', today() - 1)
	                        and bpt.status=1	
                        group by date_trunc('month',created_date);"

  "tab_bi_agr_direction_carwash":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_carwash
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_carwash 
                        SELECT 
                            today()-1 as report_date,
	                        bpt.name AS name,
                            bpt.itn AS itn,
                            provider AS provider,
                            bop.type_name AS type_name,
                            SUM(CASE WHEN created_date >= DATE(today()) - INTERVAL '1 day' AND created_date < today() THEN 1 ELSE 0 END) AS amount_prev_day,
                            case
                                when sum(sum) filter (where created_date >= date(today()) - interval '1 day' and created_date < today()) is NULL then 0
                                else sum(sum) filter (where created_date >= date(today()) - interval '1 day' and created_date<today())
                            end AS sum_prev_day,
                            SUM(CASE WHEN created_date >= date(today()) - interval '7 day' and created_date < today() THEN 1 ELSE 0 END) as amount_7_day,
                            case
                                when sum(sum) filter (where created_date >= date(today()) - interval '7 day' and created_date < today()) is NULL then 0
                                else sum(sum) filter (where created_date >= date(today()) - interval '7 day' and created_date < today())
                            end AS sum_7_day,
                            SUM(CASE WHEN created_date >= date_trunc('month', date(today())) - interval '1 month' and created_date < date_trunc('month', date(today())) THEN 1 ELSE 0 END) as amount_prev_month,
                            case
                                when sum(sum) filter (where created_date >= date_trunc('month', date(today())) - interval '1 month' and created_date < date_trunc('month', date(today()))) is NULL then 0
                                else sum(sum) filter (where created_date >= date_trunc('month', date(today())) - interval '1 month' and created_date < date_trunc('month', date(today())))
                            end AS sum_prev_month,
                            count(bpt.purchase_id) AS total_amount,
                            SUM(bpt.sum) AS total_sum
                        from oplati_analytic.bi_pos_type_2023 bpt
                        right join oplati_analytic.spr_carwash sc on bpt.device_id=sc.cash_id
                        left join oplati_analytic.bi_organisation_payments bop on bpt.itn=bop.itn
                        where sc.status='ACTIVE'
                        	and bpt.status=1
                        	and bpt.itn IS NOT NULL
                        GROUP BY bpt.name,
                                 bpt.itn,
                                 provider,
                                 bop.type_name
                        ORDER BY sum(bpt.sum) desc;"

  "tab_bi_agr_retail_indicators":
    clickhouse_query: "insert into oplati_views_report.bi_agr_retail_indicators 
                        select 
	                        act_poi.report_date,
	                        total_active_cashbox,
	                        total_inactive_cashbox,
	                        total_active_pos,
	                        total_inactive_pos,
	
	                        korona_active_cashbox,
	                        korona_inactive_cashbox,
	                        korona_active_pos,
	                        korona_inactive_pos,
	
	                        almi_active_cashbox,
	                        almi_inactive_cashbox,
	                        almi_active_pos,
	                        almi_inactive_pos,
	
	                        vitalur_active_cashbox,
	                        vitalur_inactive_cashbox,
	                        vitalur_active_pos,
	                        vitalur_inactive_pos,
	
	                        sosedi_active_cashbox,
	                        sosedi_inactive_cashbox,
	                        sosedi_active_pos,
	                        sosedi_inactive_pos, 
	
	                        santa_active_cashbox,
	                        santa_inactive_cashbox,
	                        santa_active_pos,
	                        santa_inactive_pos, 
	
	                        gippo_active_cashbox,
	                        gippo_inactive_cashbox,
	                        gippo_active_pos,
	                        gippo_inactive_pos, 
	
	                        belmarket_active_cashbox,
	                        belmarket_inactive_cashbox,
	                        belmarket_active_pos,
	                        belmarket_inactive_pos, 
	
	                        perekrestok_active_cashbox,
	                        perekrestok_inactive_cashbox,
	                        perekrestok_active_pos,
	                        perekrestok_inactive_pos, 
	
	                        dionis_active_cashbox,
	                        dionis_inactive_cashbox,
	                        dionis_active_pos,
	                        dionis_inactive_pos,
	
	                        prostor_active_cashbox,
	                        prostor_inactive_cashbox,
	                        prostor_active_pos,
	                        prostor_inactive_pos,
	
	                        green_active_cashbox,
	                        green_inactive_cashbox,
	                        green_active_pos,
	                        green_inactive_pos,
	
	                        vesta_active_cashbox,
	                        vesta_inactive_cashbox,
	                        vesta_active_pos,
	                        vesta_inactive_pos,
	
	                        zrpt_active_cashbox,
	                        zrpt_inactive_cashbox,
	                        zrpt_active_pos,
	                        zrpt_inactive_pos,
	
	                        dobronom_active_cashbox,
	                        dobronom_inactive_cashbox,
	                        dobronom_active_pos,
	                        dobronom_inactive_pos,
	
	                        dobronom_krichev_active_cashbox,
	                        dobronom_krichev_inactive_cashbox,
	                        dobronom_krichev_active_pos,
	                        dobronom_krichev_inactive_pos,
	
	                        dobronom_gomel_active_cashbox,
	                        dobronom_gomel_inactive_cashbox,
	                        dobronom_gomel_active_pos,
	                        dobronom_gomel_inactive_pos,
	
	                        dobronom_grodno_active_cashbox,
	                        dobronom_grodno_inactive_cashbox,
	                        dobronom_grodno_active_pos,
	                        dobronom_grodno_inactive_pos,
	
	                        dobronom_volkovysk_active_cashbox,
	                        dobronom_volkovysk_inactive_cashbox,
	                        dobronom_volkovysk_active_pos,
	                        dobronom_volkovysk_inactive_pos,
	
	                        dobronom_bobruysk_active_cashbox,
	                        dobronom_bobruysk_inactive_cashbox,
	                        dobronom_bobruysk_active_pos,
	                        dobronom_bobruysk_inactive_pos,

	                        prostor_new_active_cashbox,
	                        prostor_new_inactive_cashbox,
	                        prostor_new_active_pos,
	                        prostor_new_inactive_pos
	
                        from (
                            select 
	                            today() - 1 as report_date,
	                        	count(DISTINCT device_id) filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512', '191634233', '300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962'))	as total_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512', '191634233', '300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962'))	as total_active_pos,
		
	                            count(DISTINCT device_id) filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085'))	as korona_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085'))	as korona_active_pos,
  
	                            count(DISTINCT device_id) filter (where itn in ('800016624')) as almi_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('800016624')) as almi_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('100921458')) as vitalur_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('100921458')) as vitalur_active_pos,	
	
	                            count(DISTINCT device_id) filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')) as sosedi_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')) as sosedi_active_pos,	
	
	                            count(DISTINCT device_id) filter (where itn in ('291313486')) as santa_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('291313486')) as santa_active_pos,	
	
	                            count(DISTINCT device_id) filter (where itn in ('800001064')) as gippo_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('800001064')) as gippo_active_pos,	
	
	                            count(DISTINCT device_id) filter (where itn in ('190839877','700002779', '100220134','701483289')) as belmarket_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('190839877','700002779', '100220134','701483289')) as belmarket_active_pos,	
		
	                            count(DISTINCT device_id) filter (where itn in ('790274799')) as perekrestok_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('790274799')) as perekrestok_active_pos,	
	
	                            count(DISTINCT device_id) filter (where itn in ('390286042')) as dionis_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('390286042')) as dionis_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('193203512')) as prostor_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('193203512')) as prostor_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('191634233')) as green_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('191634233')) as green_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('300200651')) as vesta_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('300200651')) as vesta_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('100103703')) as zrpt_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('100103703')) as zrpt_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('191178504')) as dobronom_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('191178504')) as dobronom_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('700850740')) as dobronom_krichev_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('700850740')) as dobronom_krichev_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('401162176')) as dobronom_gomel_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('401162176')) as dobronom_gomel_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('500841385')) as dobronom_grodno_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('500841385')) as dobronom_grodno_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('500838191')) as dobronom_volkovysk_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('500838191')) as dobronom_volkovysk_active_pos,
	
	                            count(DISTINCT device_id) filter (where itn in ('701483250')) as dobronom_bobruysk_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('701483250')) as dobronom_bobruysk_active_pos,

	                            count(DISTINCT device_id) filter (where itn in ('193854962')) as prostor_new_active_cashbox,
	                            count(DISTINCT pos_id) filter (where itn in ('193854962')) as prostor_new_active_pos

                            from oplati_analytic.bi_pos_type bpt
                            where
   		                        created_date ::date < today() and 
   		                        status  = 1 and 
   		                        itn in ('102312319', '102377059', '102382074', '201015032','300988497',
                                        '401166051', '500840746', '601075914', '601077667','700849085',
                                        '800016624', '100921458', '101454161', '101171198','100088694',
                                        '100230639', '190757183', '191923668', '291313486','800001064',
                                        '190839877', '700002779', '100220134', '701483289','790274799',
                                        '390286042','193203512','191634233','300200651','100103703',
                                        '191178504', '700850740', '401162176', '500841385', '500838191', '701483250', '193854962')
                            order by report_date desc 
                        ) act_poi

                        left join (
                            select 
	                            today() - 1 as report_date,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512','191634233','300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962'))	as total_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085'))	as korona_inactive_cashbox,
  
	                            count(DISTINCT cash_id)	filter (where itn in ('800016624')) as almi_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('100921458')) as vitalur_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')) as sosedi_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('291313486')) as santa_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('800001064')) as gippo_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('190839877','700002779', '100220134','701483289')) as belmarket_inactive_cashbox,
		
	                            count(DISTINCT cash_id)	filter (where itn in ('790274799')) as perekrestok_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('390286042')) as dionis_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('193203512')) as prostor_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('191634233')) as green_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('300200651')) as vesta_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('100103703')) as zrpt_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('191178504')) as dobronom_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('700850740')) as dobronom_krichev_inactive_cashbox,

	                            count(DISTINCT cash_id)	filter (where itn in ('401162176')) as dobronom_gomel_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('500841385')) as dobronom_grodno_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('500838191')) as dobronom_volkovysk_inactive_cashbox,
	
	                            count(DISTINCT cash_id)	filter (where itn in ('701483250')) as dobronom_bobruysk_inactive_cashbox,

	                            count(DISTINCT cash_id)	filter (where itn in ('193854962')) as prostor_new_inactive_cashbox

                            from oplati_analytic.bi_organisation_payments bop
                            left join oplati_analytic.spr_pos_area spa on bop.org_id =spa.org_id
                            join oplati_analytic.spr_cashbox_area sca on sca.pos_id=spa.pos_id
                            where spa.close_date is null and sca.open_date ::date < today() and
                                cash_id not in (
                                    select distinct device_id
                                    from oplati_analytic.bi_pos_type bpt
                                    where status = 1 and 
           		                        itn in ('102312319','102377059','102382074','201015032','300988497',
                                                '401166051','500840746','601075914','601077667','700849085',
                                                '800016624','100921458','101454161','101171198','100088694',
                                                '100230639','190757183','191923668','291313486','800001064',
                                                '190839877','700002779','100220134','701483289','790274799',
                                                '390286042','193203512','191634233','300200651','100103703',
                                                '191178504','700850740', '401162176', '500841385', '500838191', '701483250', '193854962')
                                )
                        ) in_cash
                        on act_poi.report_date = in_cash.report_date

                        left join (
                            select 
	                            today() - 1 as report_date,
	                            	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512','191634233','300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962'))	as total_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085'))	as korona_inactive_pos,
  
	                            count(DISTINCT spa.pos_id) filter (where itn in ('800016624')) as almi_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('100921458')) as vitalur_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')) as sosedi_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('291313486')) as santa_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('800001064')) as gippo_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('190839877','700002779', '100220134','701483289')) as belmarket_inactive_pos,
		
	                            count(DISTINCT spa.pos_id) filter (where itn in ('790274799')) as perekrestok_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('390286042')) as dionis_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('193203512')) as prostor_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('191634233')) as green_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('300200651')) as vesta_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('100103703')) as zrpt_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('191178504')) as dobronom_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('700850740')) as dobronom_krichev_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('401162176')) as dobronom_gomel_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('500841385')) as dobronom_grodno_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('500838191')) as dobronom_volkovysk_inactive_pos,
	
	                            count(DISTINCT spa.pos_id) filter (where itn in ('701483250')) as dobronom_bobruysk_inactive_pos,

	                            count(DISTINCT spa.pos_id) filter (where itn in ('193854962')) as prostor_new_inactive_pos

                            from oplati_analytic.bi_organisation_payments bop
                            left join oplati_analytic.spr_pos_area spa on bop.org_id =spa.org_id
                            join oplati_analytic.spr_cashbox_area sca on sca.pos_id=spa.pos_id
                            where spa.close_date is null and spa.open_date ::date < today() and
                                sca.pos_id not in (
                                    select distinct pos_id
                                    from oplati_analytic.bi_pos_type bpt
                                    where 
           		                        status = 1 and 
           		                        itn in ('102312319','102377059','102382074','201015032','300988497',
                                                '401166051','500840746','601075914','601077667','700849085',
                                                '800016624','100921458','101454161','101171198','100088694',
                                                '100230639','190757183','191923668','291313486','800001064',
                                                '190839877','700002779','100220134','701483289','790274799',
                                                '390286042','193203512','191634233','300200651','100103703',
                                                '191178504','700850740','401162176','500841385','500838191','701483250', '193854962')
                                    )
                        ) inact_pos
                        on act_poi.report_date = inact_pos.report_date;"

  "tab_bi_agr_non_active_retail":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_non_active_retail
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_non_active_retail
                        SELECT
	 	                    today()-1 as report_date,
		                    case
                               when itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085') then 'Корона'
                               when itn='800016624' then 'АЛМИ'
                               when itn ='100921458' then 'Виталюр'
                               when itn in ('101454161','101171198','100088694','100230639','190757183','191923668') then 'Соседи'
                               when itn ='291313486' then 'Санта'
                               when itn='800001064' then 'ГИППО'
                               when itn in ('190839877','700002779','100220134','701483289') then 'БЕЛМАРКЕТ'
                               when itn='790274799' then 'ПЕРЕКРЕСТОК'
                               when itn='390286042' then 'ДИОНИС'
       	                    end AS retail,
       	                    itn AS itn,
       	                    name AS name,
       	                    pos_name AS pos_name,
       	                    reg_num AS reg_num
                        FROM (
	                        select
		                        bop.name as name,
                                bop.itn as itn,
                                bop.type_name as type_name,
                                spa.pos_name as pos_name,
                                sca.reg_num as reg_num,
                                sca.open_date as open_date,
                                sca.cash_id as cash_id,
                                spa.city as city,
                                spa.region as region,
                                spa.pos_id as pos_id
                            from oplati_analytic.bi_organisation_payments bop
                            left join oplati_analytic.spr_pos_area spa on bop.org_id =spa.org_id
                            join oplati_analytic.spr_cashbox_area sca on sca.pos_id=spa.pos_id
                            where spa.close_date is null
                                and itn in ('102312319','102377059','102382074','201015032','300988497',
                                            '401166051','500840746','601075914','601077667','700849085',
                                            '800016624','100921458','101454161','101171198','100088694',
                                            '100230639','190757183','191923668','291313486','800001064',
                                            '190839877','700002779','100220134','701483289','790274799','390286042')
                        ) AS virtual_table
                        WHERE ((cash_id not in
                            (select distinct device_id
                            from oplati_analytic.bi_pos_type bpt
                            where status  = 1 and itn in (
                                            '102312319','102377059','102382074','201015032','300988497',
                                            '401166051','500840746','601075914','601077667','700849085',
                                            '800016624','100921458','101454161','101171198','100088694',
                                            '100230639','190757183','191923668','291313486','800001064',
                                            '190839877','700002779','100220134','701483289','790274799','390286042'))))
                        GROUP BY case
                            when itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085') then 'Корона'
                            when itn='800016624' then 'АЛМИ'
                            when itn ='100921458' then 'Виталюр'
                            when itn in ('101454161', '101171198','100088694','100230639','190757183','191923668') then 'Соседи'
                            when itn ='291313486' then 'Санта'
                            when itn='800001064' then 'ГИППО'
                            when itn in ('190839877','700002779','100220134','701483289') then 'БЕЛМАРКЕТ'
                            when itn='790274799' then 'ПЕРЕКРЕСТОК'
                            when itn='390286042' then 'ДИОНИС'
                        end,
                        itn,
                        name,
                        pos_name,
                        reg_num;"

  "tab_bi_agr_active_retail":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_active_retail
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_active_retail
                        SELECT 
		                    today() - 1 as report_date,
		                    case
                                when itn in ('102312319', '102377059', '102382074','201015032','300988497','401166051', '500840746', '601075914','601077667','700849085') then 'Корона'
                                when itn='800016624'  then 'АЛМИ'
                                when itn ='100921458' then 'Виталюр'
                                when itn in ('101454161', '101171198', '100088694','100230639', '190757183', '191923668') then 'Соседи'
                                when itn ='291313486' then 'Санта'
                                when itn='800001064' then 'ГИППО'
                                when itn in ('190839877','700002779','100220134','701483289') then 'БЕЛМАРКЕТ'
                                when itn='790274799' then 'ПЕРЕКРЕСТОК'
                                when itn='390286042' then 'ДИОНИС'
       	                    end AS \"Retail\",
       	                    itn AS itn,
       	                    name AS name,
       	                    pos_name AS pos_name,
       	                    region AS region,
       	                    city AS city,
       	                    reg_num AS reg_num,
       	                    count(distinct purchase_id) filter (where created_date>=date_trunc('month', date(today())) - interval '1 month' and created_date<date_trunc('month', date(today()))) AS amount_transactions_pr_m,
       	                    case
                                when sum(round(sum,2)) filter (where created_date >= date_trunc('month', date(today())) - interval '1 month' and created_date < date_trunc('month', date(today()))) is NULL then 0
                                else sum(round(sum,2)) filter (where created_date >= date_trunc('month', date(today())) - interval '1 month' and created_date < date_trunc('month', date(today())))
                            end AS sum_transactions_pr_m,
                            case
                                when avg(round(sum,2)) filter (where created_date >= date_trunc('month', date(today())) - interval '1 month' and created_date<date_trunc('month', date(today()))) is NULL then 0
                                else avg(round(sum,2)) filter (where created_date>=date_trunc('month', date(today())) - interval '1 month' and created_date<date_trunc('month', date(today())))
                            end AS avg_check_pr_m,
                            count(distinct purchase_id) AS amount_transactions,
                            sum(round(sum,2)) AS sum_transactions,
                            avg(round(sum,2)) AS avg_check,
                            count (DISTINCT operation_id) AS amount_refund,
                            case
                                when sum(ref) is NULL then 0
                                else sum(ref)
                            end AS sum_refund
                        FROM (
	                        select
		                        bpt.created_date as created_date,
                                bpt.purchase_id as purchase_id,
                                bpt.sum as sum,
                                bpt.name as name,
                                bpt.itn as itn,
                                bpt.pos_name as pos_name,
                                bpt.type_name as type_name,
                                bpt.device_id as device_id,
                                bpt.region as region,
                                bpt.city as city,
                                bpt.pos_id as pos_id,
                                sca.reg_num as reg_num,
                                btr.operation_id as operation_id,
                                sum(btr.sum) as ref
   	                        from oplati_analytic.bi_pos_type bpt
   	                        join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
   	                        left join oplati_analytic.bi_transactions_refund btr on bpt.purchase_id =btr.operation_id
   	                        where bpt.status = 1 and itn in (
   	                            '102312319', '102377059', '102382074', '201015032', '300988497',
                                '401166051', '500840746', '601075914', '601077667', '700849085',
                                '800016624', '100921458', '101454161', '101171198', '100088694',
                                '100230639', '190757183', '191923668', '291313486', '800001064',
                                '190839877', '700002779', '100220134', '701483289', '790274799','390286042'
                            )
                            group by
                                bpt.created_date,
                                bpt.purchase_id,
                                bpt.sum,
                                bpt.name,
                                bpt.itn,
                                bpt.pos_name,
                                bpt.type_name,
                                bpt.device_id,
                                bpt.region,
                                bpt.city,
                                bpt.pos_id,
                                sca.reg_num,
                                btr.operation_id
                        ) AS virtual_table
                        GROUP BY
                            case
                                when itn in ('102312319', '102377059', '102382074', '201015032', '300988497','401166051', '500840746', '601075914', '601077667', '700849085') then 'Корона'
                                when itn='800016624' then 'АЛМИ'
                                when itn ='100921458' then 'Виталюр'
                                when itn in ('101454161', '101171198', '100088694','100230639', '190757183','191923668') then 'Соседи'
                                when itn ='291313486' then 'Санта'
                                when itn='800001064' then 'ГИППО'
                                when itn in ('190839877','700002779','100220134','701483289') then 'БЕЛМАРКЕТ'
                                when itn='790274799' then 'ПЕРЕКРЕСТОК'
                                when itn='390286042' then 'ДИОНИС'
                            end,
                            itn,
                            name,
                            pos_name,
                            region,
                            city,
                            reg_num;"

  "tab_bi_agr_retail_daily":
    clickhouse_query: "insert into oplati_views_report.bi_agr_retail_daily
                        select
	                        DATE_TRUNC('day', bpt.created_date) AS report_date,
		
	                        round(sum(sum) filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512', '191634233', '300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962')),2) 	as retail_sum,
	                        count(DISTINCT purchase_id)	filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512', '191634233', '300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962'))   	as retail_amount,
	                        round(avg(sum) filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512', '191634233', '300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962')),2)	as retail_avg_check,
		
	                        round(sum(sum) filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085')),2) 	as korona_sum,
	                        count(DISTINCT purchase_id)	filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085')) 	as korona_amount,
	                        round(avg(sum) filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085')),2)	as korona_avg_check,
  
	                        round(sum(sum) filter (where itn in ('800016624')),2) as almi_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('800016624')) as almi_amount,
	                        round(avg(sum)  filter (where itn in ('800016624')),2) as almi_avg_check,
	
	                        round(sum(sum) filter (where itn in ('100921458')),2) as vitalur_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('100921458')) as vitalur_amount,
	                        round(avg(sum) filter (where itn in ('100921458')),2) as vitalur_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')),2) as sosedi_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')) as sosedi_amount,
	                        round(avg(sum) filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')),2) as sosedi_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('291313486')),2) as santa_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('291313486')) as santa_amount,
	                        round(avg(sum) filter (where itn in ('291313486')),2) as santa_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('800001064')),2) as gippo_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('800001064')) as gippo_amount,
	                        round(avg(sum) filter (where itn in ('800001064')),2) as gippo_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('190839877','700002779', '100220134','701483289')),2) as belmarket_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('190839877','700002779', '100220134','701483289')) as belmarket_amount,
	                        round(avg(sum) filter (where itn in ('190839877','700002779', '100220134','701483289')),2) as belmarket_avg_check,	
		
	                        round(sum(sum) filter (where itn in ('790274799')),2) as perekrestok_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('790274799')) as perekrestok_amount,
	                        round(avg(sum) filter (where itn in ('790274799')),2) as perekrestok_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('390286042')),2) as dionis_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('390286042')) as dionis_amount,
	                        round(avg(sum) filter (where itn in ('390286042')),2) as dionis_avg_check,

	                        round(sum(sum) filter (where itn in ('193203512')),2) as prostor_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('193203512')) as prostor_amount,
	                        round(avg(sum) filter (where itn in ('193203512')),2) as prostor_avg_check,
	
	                        round(sum(sum) filter (where itn in ('191634233')),2) as green_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('191634233')) as green_amount,
	                        round(avg(sum) filter (where itn in ('191634233')),2) as green_avg_check,
	
	                        round(sum(sum) filter (where itn in ('300200651')),2) as vesta_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('300200651')) as vesta_amount,
	                        round(avg(sum) filter (where itn in ('300200651')),2) as vesta_avg_check,
	
	                        round(sum(sum) filter (where itn in ('100103703')),2) as zrpt_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('100103703')) as zrpt_amount,
	                        round(avg(sum) filter (where itn in ('100103703')),2) as zrpt_avg_check,
		
	                        round(sum(sum) filter (where itn in ('191178504')),2) as dobronom_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('191178504')) as dobronom_amount,
	                        round(avg(sum) filter (where itn in ('191178504')),2) as dobronom_avg_check,
	
	                        round(sum(sum) filter (where itn in ('700850740')),2) as dobronom_krichev_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('700850740')) as dobronom_krichev_amount,
	                        round(avg(sum) filter (where itn in ('700850740')),2) as dobronom_krichev_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('401162176')),2) as dobronom_gomel_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('401162176')) as dobronom_gomel_amount,
	                        round(avg(sum) filter (where itn in ('401162176')),2) as dobronom_gomel_avg_check,
	
	                        round(sum(sum) filter (where itn in ('500841385')),2) as dobronom_grodno_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('500841385')) as dobronom_grodno_amount,
	                        round(avg(sum) filter (where itn in ('500841385')),2) as dobronom_grodno_avg_check,
	
	                        round(sum(sum) filter (where itn in ('500838191')),2) as dobronom_volkovysk_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('500838191')) as dobronom_volkovysk_amount,
	                        round(avg(sum) filter (where itn in ('500838191')),2) as dobronom_volkovysk_avg_check,
	
	                        round(sum(sum) filter (where itn in ('701483250')),2) as dobronom_bobruysk_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('701483250')) as dobronom_bobruysk_amount,
	                        round(avg(sum) filter (where itn in ('701483250')),2) as dobronom_bobruysk_avg_check,

				round(sum(sum) filter (where itn in ('193854962')),2) as prostor_new_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('193854962')) as prostor_new_amount,
	                        round(avg(sum) filter (where itn in ('193854962')),2) as prostor_new_avg_check
	
                        from oplati_analytic.bi_pos_type_2023 bpt
                        where 
   		                    created_date ::date = today() - 1 and 
   		                    status  = 1 and 
   		                    itn in ('102312319', '102377059', '102382074', '201015032','300988497',
                                    '401166051', '500840746', '601075914', '601077667','700849085',
                                    '800016624', '100921458', '101454161', '101171198','100088694',
                                    '100230639', '190757183', '191923668', '291313486','800001064',
                                    '190839877', '700002779', '100220134', '701483289','790274799',
                                    '390286042', '193203512', '191634233', '300200651','100103703',
                                    '191178504', '700850740', '401162176', '500841385', '500838191', '701483250', '193854962'
                            )
                        group by DATE_TRUNC('day', bpt.created_date) 
                        order by report_date asc;"

  "tab_bi_agr_retail_monthly":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_retail_monthly
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_retail_monthly
                        select
	                        DATE_TRUNC('month', bpt.created_date) AS report_date,
	                        	
	                        round(sum(sum) filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512', '191634233', '300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962')),2) 	as retail_sum,
	                        count(DISTINCT purchase_id)	filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512', '191634233', '300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962'))   	as retail_amount,
	                        round(avg(sum) filter (where itn in ('102312319', '102377059', '102382074', '201015032','300988497','401166051', '500840746', '601075914', '601077667','700849085','800016624', '100921458', '101454161', '101171198','100088694','100230639', '190757183', '191923668', '291313486','800001064','190839877', '700002779', '100220134', '701483289','790274799','390286042','193203512', '191634233', '300200651','100103703','191178504','700850740','401162176','500841385','500838191','701483250', '193854962')),2)	as retail_avg_check,
	
	                        round(sum(sum) filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085')),2) 	as korona_sum,
	                        count(DISTINCT purchase_id)	filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085')) 	as korona_amount,
	                        round(avg(sum) filter (where itn in ('102312319','102377059','102382074','201015032','300988497','401166051','500840746','601075914','601077667','700849085')),2)	as korona_avg_check,
  
	                        round(sum(sum) filter (where itn in ('800016624')),2) as almi_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('800016624')) as almi_amount,
	                        round(avg(sum) filter (where itn in ('800016624')),2) as almi_avg_check,
	
	                        round(sum(sum) filter (where itn in ('100921458')),2) as vitalur_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('100921458')) as vitalur_amount,
	                        round(avg(sum) filter (where itn in ('100921458')),2) as vitalur_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')),2) as sosedi_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')) as sosedi_amount,
	                        round(avg(sum) filter (where itn in ('101454161','101171198','100088694','100230639', '190757183','191923668')),2) as sosedi_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('291313486')),2) as santa_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('291313486')) as santa_amount,
	                        round(avg(sum) filter (where itn in ('291313486')),2) as santa_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('800001064')),2) as gippo_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('800001064')) as gippo_amount,
	                        round(avg(sum) filter (where itn in ('800001064')),2) as gippo_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('190839877','700002779', '100220134','701483289')),2) as belmarket_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('190839877','700002779', '100220134','701483289')) as belmarket_amount,
	                        round(avg(sum) filter (where itn in ('190839877','700002779', '100220134','701483289')),2) as belmarket_avg_check,	
		
	                        round(sum(sum) filter (where itn in ('790274799')),2) as perekrestok_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('790274799')) as perekrestok_amount,
	                        round(avg(sum) filter (where itn in ('790274799')),2) as perekrestok_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('390286042')),2) as dionis_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('390286042')) as dionis_amount,
	                        round(avg(sum) filter (where itn in ('390286042')),2) as dionis_avg_check,
	
	                        count(DISTINCT profile_id) as amount_customers_retail,
	
	                        round(sum(sum) filter (where itn in ('193203512')),2) as prostor_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('193203512')) as prostor_amount,
	                        round(avg(sum) filter (where itn in ('193203512')),2) as prostor_avg_check,
	
	                        round(sum(sum) filter (where itn in ('191634233')),2) as green_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('191634233')) as green_amount,
	                        round(avg(sum) filter (where itn in ('191634233')),2) as green_avg_check,
	
	                        round(sum(sum) filter (where itn in ('300200651')),2) as vesta_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('300200651')) as vesta_amount,
	                        round(avg(sum) filter (where itn in ('300200651')),2) as vesta_avg_check,
	
	                        round(sum(sum) filter (where itn in ('100103703')),2) as zrpt_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('100103703')) as zrpt_amount,
	                        round(avg(sum) filter (where itn in ('100103703')),2) as zrpt_avg_check,
	
	                        round(sum(sum) filter (where itn in ('191178504')),2) as dobronom_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('191178504')) as dobronom_amount,
	                        round(avg(sum) filter (where itn in ('191178504')),2) as dobronom_avg_check,
	
	                        round(sum(sum) filter (where itn in ('700850740')),2) as dobronom_krichev_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('700850740')) as dobronom_krichev_amount,
	                        round(avg(sum) filter (where itn in ('700850740')),2) as dobronom_krichev_avg_check,	
	
	                        round(sum(sum) filter (where itn in ('401162176')),2) as dobronom_gomel_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('401162176')) as dobronom_gomel_amount,
	                        round(avg(sum) filter (where itn in ('401162176')),2) as dobronom_gomel_avg_check,
	
	                        round(sum(sum) filter (where itn in ('500841385')),2) as dobronom_grodno_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('500841385')) as dobronom_grodno_amount,
	                        round(avg(sum) filter (where itn in ('500841385')),2) as dobronom_grodno_avg_check,
	
	                        round(sum(sum) filter (where itn in ('500838191')),2) as dobronom_volkovysk_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('500838191')) as dobronom_volkovysk_amount,
	                        round(avg(sum) filter (where itn in ('500838191')),2) as dobronom_volkovysk_avg_check,
	
	                        round(sum(sum) filter (where itn in ('701483250')),2) as dobronom_bobruysk_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('701483250')) as dobronom_bobruysk_amount,
	                        round(avg(sum) filter (where itn in ('701483250')),2) as dobronom_bobruysk_avg_check,

	                        round(sum(sum) filter (where itn in ('193854962')),2) as prostor_new_sum,
	                        count(DISTINCT purchase_id) filter (where itn in ('193854962')) as prostor_new_amount,
	                        round(avg(sum) filter (where itn in ('193854962')),2) as prostor_new_avg_check
	
                        from oplati_analytic.bi_pos_type_2023 bpt
                        where 
   		                    DATE_TRUNC('month', bpt.created_date) = DATE_TRUNC('month', today() - 1)
   		                    and status  = 1
   		                    and itn in ('102312319', '102377059', '102382074', '201015032','300988497',
                                    	'401166051', '500840746', '601075914', '601077667','700849085',
                                    	'800016624', '100921458', '101454161', '101171198','100088694',
                                    	'100230639', '190757183', '191923668', '291313486','800001064',
                                    	'190839877', '700002779', '100220134', '701483289','790274799',
                                    	'390286042', '193203512', '191634233', '300200651','100103703',
                                    	'191178504','700850740','401162176','500841385','500838191','701483250', '193854962'
                                   		)
                        group by DATE_TRUNC('month', bpt.created_date) 
                        order by report_date asc;"

  "tab_bi_agr_pharmacy_inactive":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_pharmacy_inactive
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_pharmacy_inactive
                        select 
	                        today() - 1 as report_date,
	                        bop.name AS name,
	                        bop.itn AS itn,
	                        spa.pos_name AS pos_name,
	                        sca.reg_num AS reg_num,
	                        spa.city AS city,
	                        spa.region AS region
                        from oplati_analytic.bi_organisation_payments bop
                        left join oplati_analytic.spr_pos_area spa on bop.org_id =spa.org_id
                        join oplati_analytic.spr_cashbox_area sca on sca.pos_id=spa.pos_id
                        where 
	                        sca.close_date is null and 
	                        bop.type_name='Аптеки'and 
	                        cash_id not in (
	                            select distinct bpt.device_id
	                            from oplati_analytic.bi_pos_type bpt
	                            left join oplati_analytic.bi_organisation_payments bop on bpt.org_id=bop.org_id
	                            where bop.type_name='Аптеки' and status=1
                            );"

  "tab_bi_agr_pharmacy_active":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_pharmacy_active
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_pharmacy_active
                        SELECT 
	                        today() - 1 as report_date,	
	                        bpt.name AS name,
                            bpt.itn AS itn,
                            bpt.pos_name AS pos_name,
                            bpt.city AS city,
                            bpt.region AS region,
                            sca.reg_num AS reg_num,
                            count (distinct purchase_id) filter (where created_date < date(today()) and created_date > date(today()) - interval '1 month') AS amount_prev_month,
                            case
                                when sum(bpt.sum) filter (where created_date < date(today()) and created_date > date(today()) - interval '1 month') is NULL then 0
                                else sum(bpt.sum) filter (where created_date < date(today()) and created_date > date(today()) - interval '1 month')
                            end AS sum_prev_month,
                            case
                                when avg (bpt.sum) filter (where created_date < date(today()) and created_date > date(today()) - interval '1 month') is NULL then 0
                                else avg (bpt.sum) filter (where created_date < date(today()) and created_date > date(today()) - interval '1 month')
                            end AS avg_check_prev_month,
                            count(DISTINCT purchase_id) AS total_amount,
                            case
                                when sum(bpt.sum) is NULL then 0
                                else sum(bpt.sum)
                            end AS total_sum,
                            case
                                when avg(bpt.sum) is NULL then 0
                                else avg(bpt.sum)
                            end AS toatl_avg_check,
                            count(DISTINCT operation_id) AS total_amount_ref,
                            case
                                when sum(btr.sum) is NULL then 0
                                else sum(btr.sum)
                            end AS total_sum_ref
                        from oplati_analytic.bi_pos_type bpt
                        left join oplati_analytic.bi_organisation_payments bop on bpt.itn=bop.itn
                        join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
                        left join oplati_analytic.bi_transactions_refund btr on bpt.purchase_id =btr.operation_id
                        where bop.type_name ='Аптеки'
	                        and bpt.status=1
                            and sca.close_date is NULL
                        GROUP BY
                            bpt.name,
                            bpt.itn,
                            bpt.pos_name,
                            bpt.city,
                            bpt.region,
                            sca.reg_num
                        ORDER BY sum(bpt.sum) desc;"

  "tab_bi_agr_pharmacy":
    clickhouse_query: "insert into oplati_views_report.bi_agr_pharmacy
                        select * from (
	                        (
	                            select 
	                                DATE_TRUNC('day', created_date) as report_date,
	                                'Суммы по операциям'as parametr_type,
	                                sum(bpt.sum) as total,
	                                case
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('100364237')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('100364237'))
	                                end  as belfarm,
	                                case
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972'))	is null )
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972'))
	                                end as belfarm_other,
	                                case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('191063745','190431476')) is null )
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('191063745','190431476'))
	                                end as zlist_inlek,
	                                case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('391730131'))is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('391730131'))
	                                end as farmostrov,
	                                case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('101376425','100751212')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('101376425','100751212'))
	                                end as remedika,
	                                case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696'))	is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696'))
	                                end as adel_dobrya,
	                                case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275'))
	                                end as lybimy_pharm,
	                                case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('192937675'))is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('192937675'))
	                                end as berejliv_pharm,
	                                case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('193428904')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('193428904'))
	                                end as astrafarm,
	                                case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462'))is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462'))
	                                end as ostrov_zdorovya,
	                                case when (sum(bpt.sum) filter (where bpt.itn in ('193428904'))is null )then 0 else sum(bpt.sum) filter (where bpt.itn in ('193428904'))end as ligmaton,
	                                case when (sum(bpt.sum) filter (where bpt.itn in ('291267166'))is null )then 0 else sum(bpt.sum) filter (where bpt.itn in ('291267166'))end as gt_gratiafarm,
	                                case when (sum(bpt.sum) filter (where bpt.itn in ('190593725'))is null )then 0 else sum(bpt.sum) filter (where bpt.itn in ('190593725'))end as my_apteka,
	                                case when (sum(bpt.sum) filter (where bpt.itn in ('690594907'))is null )then 0 else sum(bpt.sum) filter (where bpt.itn in ('690594907'))end as eklinia,
	                                case when (sum(bpt.sum) filter (where bpt.itn in ('690025786'))is null )then 0 else sum(bpt.sum) filter (where bpt.itn in ('690025786'))end as novamedica,
	                                case when (sum(bpt.sum) filter (where bpt.itn in ('190549048'))is null )then 0 else sum(bpt.sum) filter (where bpt.itn in ('190549048'))end as medvaks

	                            from oplati_analytic.bi_pos_type_2023 bpt
	                            left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
	                            left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
	                            left join oplati_analytic.bi_transactions_refund btr on bpt.purchase_id =btr.operation_id
	                            where bop.type_name ='Аптеки' 
	                                and bpt.status=1
	                                and sca.close_date is null 
	                                and created_date::date = today() - 1
	                            group by DATE_TRUNC('day', created_date)
	                            order by report_date desc
                        	)
	
                        	union all
                        	
	                        (
		                        select 
		                            DATE_TRUNC('day', created_date) as report_date,
		                            'Количество операций'as parametr_type,
		                            count(*) as total,
		                            case
		                            	when (sum(case when bpt.itn in ('100364237') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('100364237') then 1 else 0 end)
		                            end  as belfarm,
		                            case
		                            	when (sum(case when bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972') then 1 else 0 end)
		                            end as belfarm_other,
		                            case 
		                            	when (sum(case when bpt.itn in ('191063745','190431476') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('191063745','190431476') then 1 else 0 end)
		                            end as zlist_inlek,
		                            case 
		                            	when (sum(case when bpt.itn in ('391730131') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('391730131') then 1 else 0 end)
		                            end as farmostrov,
		                            case 
		                            	when (sum(case when bpt.itn in ('101376425','100751212') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('101376425','100751212') then 1 else 0 end)
		                            end as remedika,
		                            case 
		                            	when (sum(case when bpt.itn in ('300280870','390374811', '590004353','490001187','700232696') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('300280870','390374811', '590004353','490001187','700232696') then 1 else 0 end)
		                            end as adel_dobrya,
		                            case 
		                            	when (sum(case when bpt.itn in ('100456458', '191582872', '500221613', '190736275') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('100456458', '191582872', '500221613', '190736275') then 1 else 0 end)
		                            end as lybimy_pharm,
		                            case 
		                            	when (sum(case when bpt.itn in ('192937675') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('192937675') then 1 else 0 end)
		                            end as berejliv_pharm,
		                            case 
		                            	when (sum(case when bpt.itn in ('193428904') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('193428904') then 1 else 0 end)
		                            end as astrafarm,
		                            case 
		                            	when (sum(case when bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462') then 1 else 0 end)
		                            end as ostrov_zdorovya,
		                            
		                            case when (sum(case when bpt.itn in ('193428904') then 1 else 0 end) is null) then 0 else sum(case when bpt.itn in ('193428904') then 1 else 0 end) end as ligmaton,
		                            case when (sum(case when bpt.itn in ('291267166') then 1 else 0 end) is null) then 0 else sum(case when bpt.itn in ('291267166') then 1 else 0 end) end as gt_gratiafarm,
		                            case when (sum(case when bpt.itn in ('190593725') then 1 else 0 end) is null) then 0 else sum(case when bpt.itn in ('190593725') then 1 else 0 end) end as my_apteka,
		                            case when (sum(case when bpt.itn in ('690594907') then 1 else 0 end) is null) then 0 else sum(case when bpt.itn in ('690594907') then 1 else 0 end) end as eklinia,
		                            case when (sum(case when bpt.itn in ('690025786') then 1 else 0 end) is null) then 0 else sum(case when bpt.itn in ('690025786') then 1 else 0 end) end as novamedica,
		                            case when (sum(case when bpt.itn in ('190549048') then 1 else 0 end) is null) then 0 else sum(case when bpt.itn in ('190549048') then 1 else 0 end) end as medvaks
		
		                        from oplati_analytic.bi_pos_type_2023 bpt
		                        left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                        left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                        where bop.type_name ='Аптеки'  
		                            and bpt.status=1
		                            and sca.close_date is null
		                            and created_date::date = today() - 1
		                        group by DATE_TRUNC('day', created_date)
		                        order by report_date desc
	                        )
	
	                        union all
	
	                        (
		                		select 
		                            DATE_TRUNC('day', created_date) as report_date,
		                            'Средний чек(в день)'as parametr_type,
		                            (round(avg(sum), 2)) :: Decimal(10, 2) as total,
		                            (case
		                            	when (round(avg(sum) filter (where bpt.itn in ('100364237')),2) is null)
		                            	then 0 else round(avg(sum)  filter (where bpt.itn in ('100364237')),2)
		                            end) :: Decimal(10, 2)  as belfarm,
		                            (case
		                            	when (round(avg(sum) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972')), 2)
		                            end) :: Decimal(10, 2) as belfarm_other,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('191063745','190431476')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('191063745','190431476')), 2)
		                            end) :: Decimal(10, 2) as zlist_inlek,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('391730131')), 2)is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('391730131')), 2)
		                            end) :: Decimal(10, 2) as farmostrov,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('101376425','100751212')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('101376425','100751212')), 2)
		                            end) :: Decimal(10, 2) as remedika,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696')), 2)
		                            end) :: Decimal(10, 2) as adel_dobrya,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275')), 2)	is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275')), 2)
		                            end) :: Decimal(10, 2) as lybimy_pharm,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('192937675')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('192937675')), 2)
		                            end) :: Decimal(10, 2) as berejliv_pharm,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('193428904')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('193428904')), 2)
		                            end) :: Decimal(10, 2) as astrafarm,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462')), 2)is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462')), 2)
		                            end) :: Decimal(10, 2) as ostrov_zdorovya,
		                            (case when (round(avg(sum) filter (where bpt.itn in ('193428904')), 2) is null) then 0 else round(avg(sum) filter (where bpt.itn in ('193428904')), 2) end) :: Decimal(10, 2) as ligmaton,
		                            (case when (round(avg(sum) filter (where bpt.itn in ('291267166')), 2) is null) then 0 else round(avg(sum) filter (where bpt.itn in ('291267166')), 2) end) :: Decimal(10, 2) as gt_gratiafarm,
		                            (case when (round(avg(sum) filter (where bpt.itn in ('190593725')), 2) is null) then 0 else round(avg(sum) filter (where bpt.itn in ('190593725')), 2) end) :: Decimal(10, 2) as my_apteka,
		                            (case when (round(avg(sum) filter (where bpt.itn in ('690594907')), 2) is null) then 0 else round(avg(sum) filter (where bpt.itn in ('690594907')), 2) end) :: Decimal(10, 2) as eklinia,
		                            (case when (round(avg(sum) filter (where bpt.itn in ('690025786')), 2) is null) then 0 else round(avg(sum) filter (where bpt.itn in ('690025786')), 2) end) :: Decimal(10, 2) as novamedica,
		                            (case when (round(avg(sum) filter (where bpt.itn in ('190549048')), 2) is null) then 0 else round(avg(sum) filter (where bpt.itn in ('190549048')), 2) end) :: Decimal(10, 2) as medvaks

		                        from oplati_analytic.bi_pos_type_2023 bpt
		                        left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                        left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                        where bop.type_name ='Аптеки' 
		                            and bpt.status = 1
		                            and sca.close_date is null
		                            and created_date::date = today() - 1
		                        group by DATE_TRUNC('day', created_date)
		                        order by report_date desc
	                        )
	
	                        union all
	
	                        (
		                        select
		                            sc.calendar_date as report_date,
		                            parametr_type,
		                            total,belfarm,
		                            belfarm_other,
		                            zlist_inlek,
		                            farmostrov,
		                            remedika,
		                            adel_dobrya,
		                            lybimy_pharm,
		                            berejliv_pharm,
		                            astrafarm,
		                            ostrov_zdorovya,
		                            ligmaton,
		                            gt_gratiafarm,
		                            my_apteka,
		                            eklinia,
		                            novamedica,
		                            medvaks
		                        from oplati_analytic.spr_calendar sc
		                        right join(
		                            select 
		                                DATE_TRUNC('month', created_date::date) as t_date,
		                                'Средний чек(в месяц)'as parametr_type,
		                                (round(avg(sum), 2)) :: Decimal(10, 2) as total,
		                                (case
		                                	when (round(avg(sum) filter (where bpt.itn in ('100364237')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('100364237')), 2)
		                                end) :: Decimal(10,2) as belfarm,
		                                (case
		                                	when (round(avg(sum) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972')), 2)
		                                end) :: Decimal(10,2) as belfarm_other,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('191063745','190431476')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('191063745','190431476')), 2)
		                                end) :: Decimal(10,2) as zlist_inlek,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('391730131')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('391730131')), 2)
		                                end) :: Decimal(10,2) as farmostrov,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('101376425','100751212')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('101376425','100751212')), 2)
		                                end) :: Decimal(10,2) as remedika,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696')), 2)
		                                end) :: Decimal(10,2) as adel_dobrya,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275')), 2)
		                                end) :: Decimal(10,2) as lybimy_pharm,
		                                (case 
		                                	when (round(avg(sum)  filter (where bpt.itn in ('192937675')), 2) is null)
		                                	then 0 else round(avg(sum)  filter (where bpt.itn in ('192937675')), 2)
		                                end) :: Decimal(10,2) as berejliv_pharm,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('193428904')),2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('193428904')),2)
		                                end) :: Decimal(10,2) as astrafarm,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462')), 2)is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462')), 2)
		                                end) :: Decimal(10,2) as ostrov_zdorovya,
		                                (case when (round(avg(sum) filter (where bpt.itn in ('193428904')), 2)is null) then 0 else round(avg(sum) filter (where bpt.itn in ('193428904')), 2)end) :: Decimal(10,2) as ligmaton,
		                                (case when (round(avg(sum) filter (where bpt.itn in ('291267166')), 2)is null) then 0 else round(avg(sum) filter (where bpt.itn in ('291267166')), 2)end) :: Decimal(10,2) as gt_gratiafarm,
		                                (case when (round(avg(sum) filter (where bpt.itn in ('190593725')), 2)is null) then 0 else round(avg(sum) filter (where bpt.itn in ('190593725')), 2)end) :: Decimal(10,2) as my_apteka,
		                                (case when (round(avg(sum) filter (where bpt.itn in ('690594907')), 2)is null) then 0 else round(avg(sum) filter (where bpt.itn in ('690594907')), 2)end) :: Decimal(10,2) as eklinia,
		                                (case when (round(avg(sum) filter (where bpt.itn in ('690025786')), 2)is null) then 0 else round(avg(sum) filter (where bpt.itn in ('690025786')), 2)end) :: Decimal(10,2) as novamedica,
		                                (case when (round(avg(sum) filter (where bpt.itn in ('190549048')), 2)is null) then 0 else round(avg(sum) filter (where bpt.itn in ('190549048')), 2)end) :: Decimal(10,2) as medvaks
		
		                            from oplati_analytic.bi_pos_type_2023 bpt
		                            left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                            left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                            where bop.type_name ='Аптеки' 
		                                and bpt.status=1
		                                and sca.close_date is null
		                                and date_trunc('month', created_date::date) = date_trunc('month', today() - 1) 
		                            group by DATE_TRUNC('month', created_date::date)
		                            order by t_date desc
		                        ) date_avg
		                        on date_trunc('month', sc.calendar_date) = date_trunc('month', date_avg.t_date)
		                         and date_trunc('year', sc.calendar_date) = date_trunc('year', date_avg.t_date)  
		                        where date_trunc('day', sc.calendar_date::date) = date_trunc('day', today() - 1)
		                        order by sc.calendar_date asc
	                        )
	
	                        union all
	
	                        (
		                        select 
		                            today() - 1 as report_date,
		                            'Количество активных касс'as parametr_type,
		                            (count(DISTINCT device_id)) :: Decimal(10, 2) as total,
		                            (case
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('100364237')) is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('100364237'))
		                            end) :: Decimal(10, 2) as belfarm,
		                            (case
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972')) is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972'))
		                            end) :: Decimal(10, 2) as belfarm_other,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('191063745','190431476'))	is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('191063745','190431476'))
		                            end) :: Decimal(10, 2) as zlist_inlek,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('391730131')) is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('391730131'))
		                            end) :: Decimal(10, 2) as farmostrov,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('101376425','100751212')) is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('101376425','100751212'))
		                            end) :: Decimal(10, 2) as remedika,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696')) is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696'))
		                            end) :: Decimal(10, 2) as adel_dobrya,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275')) is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275'))
		                            end) :: Decimal(10, 2) as lybimy_pharm,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('192937675'))is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('192937675'))
		                            end) :: Decimal(10, 2) as berejliv_pharm,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('193428904')) is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('193428904'))
		                            end) :: Decimal(10, 2) as astrafarm,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462')) is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462'))
		                            end) :: Decimal(10, 2) as ostrov_zdorovya,
		                            (case when (count(DISTINCT device_id) filter (where bpt.itn in ('193428904')) is null) then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('193428904')) end) :: Decimal(10, 2) as ligmaton,
		                            (case when (count(DISTINCT device_id) filter (where bpt.itn in ('291267166')) is null) then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('291267166')) end) :: Decimal(10, 2) as gt_gratiafarm,
		                            (case when (count(DISTINCT device_id) filter (where bpt.itn in ('190593725')) is null) then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('190593725')) end) :: Decimal(10, 2) as my_apteka,
		                            (case when (count(DISTINCT device_id) filter (where bpt.itn in ('690594907')) is null) then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('690594907')) end) :: Decimal(10, 2) as eklinia,
		                            (case when (count(DISTINCT device_id) filter (where bpt.itn in ('690025786')) is null) then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('690025786')) end) :: Decimal(10, 2) as novamedica,
		                            (case when (count(DISTINCT device_id) filter (where bpt.itn in ('190549048')) is null) then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('190549048')) end) :: Decimal(10, 2) as medvaks

		                        from oplati_analytic.bi_pos_type bpt
		                        left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                        join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                        where bop.type_name ='Аптеки'  
		                            and bpt.status=1
		                            and sca.close_date is NULL
	                        )
	
	                        union all
	
	                        (
		                        select 
		                            today() - 1 as report_date,
		                            'Количество активных точек продаж'as parametr_type,
		                            (count(DISTINCT bpt.pos_id)) :: Decimal(10, 2) as total,
		                            (case
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('100364237')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('100364237'))
		                            end) :: Decimal(10, 2) as belfarm,
		                            (case
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972'))
		                            end) :: Decimal(10, 2) as belfarm_other,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('191063745','190431476')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('191063745','190431476'))
		                            end) :: Decimal(10, 2) as zlist_inlek,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('391730131')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('391730131'))
		                            end) :: Decimal(10, 2) as farmostrov,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('101376425','100751212')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('101376425','100751212'))
		                            end) :: Decimal(10, 2) as remedika,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('300280870','390374811', '590004353','490001187','700232696'))
		                            end) :: Decimal(10, 2) as adel_dobrya,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275'))	is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('100456458', '191582872', '500221613', '190736275'))
		                            end) :: Decimal(10, 2) as lybimy_pharm,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192937675')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192937675'))
		                            end) :: Decimal(10, 2) as berejliv_pharm,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193428904')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193428904'))
		                            end) :: Decimal(10, 2) as astrafarm,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462'))
		                            end) :: Decimal(10, 2) as ostrov_zdorovya,
		                            (case when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193428904')) is null) then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193428904')) end):: Decimal(10, 2) as ligmaton,
		                            (case when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('291267166')) is null) then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('291267166')) end):: Decimal(10, 2) as gt_gratiafarm,
		                            (case when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('190593725')) is null) then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('190593725')) end):: Decimal(10, 2) as my_apteka,
		                            (case when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('690594907')) is null) then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('690594907')) end):: Decimal(10, 2) as eklinia,
		                            (case when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('690025786')) is null) then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('690025786')) end):: Decimal(10, 2) as novamedica,
		                            (case when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('190549048')) is null) then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('190549048')) end):: Decimal(10, 2) as medvaks
		
		                        from oplati_analytic.bi_pos_type bpt
		                        left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                        join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                        where bop.type_name ='Аптеки'  
		                            and bpt.status=1
		                            and sca.close_date is NULL
	                        )
	
	                        union all
	
	                        (
		                        select 
		                            today() - 1 as report_date,
		                            'Количество неактивных касс'as parametr_type,
		                            (count(DISTINCT cash_id)) :: Decimal(10, 2) as total,
		                            (case
		                            	when (count(DISTINCT cash_id) filter (where itn in ('100364237')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('100364237'))
		                            end) :: Decimal(10, 2) as belfarm,
		                            (case
		                            	when (count(DISTINCT cash_id) filter (where itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972'))
		                            end) :: Decimal(10, 2) as belfarm_other,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('191063745','190431476')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('191063745','190431476'))
		                            end) :: Decimal(10, 2) as zlist_inlek,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('391730131')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('391730131'))
		                            end) :: Decimal(10, 2) as farmostrov,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('101376425','100751212')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('101376425','100751212'))
		                            end) :: Decimal(10, 2) as remedika,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('300280870','390374811', '590004353','490001187','700232696')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('300280870','390374811', '590004353','490001187','700232696'))
		                            end) :: Decimal(10, 2) as adel_dobrya,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('100456458', '191582872', '500221613', '190736275')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('100456458', '191582872', '500221613', '190736275'))
		                            end) :: Decimal(10, 2) as lybimy_pharm,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('192937675')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('192937675'))
		                            end) :: Decimal(10, 2) as berejliv_pharm,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('193428904')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('193428904'))
		                            end) :: Decimal(10, 2) as astrafarm,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462'))
		                            end) :: Decimal(10, 2) as ostrov_zdorovya,
		                            (case when (count(DISTINCT cash_id) filter (where itn in ('193428904'))is null) then 0 else count(DISTINCT cash_id) filter (where itn in ('193428904')) end) :: Decimal(10, 2) as ligmaton,
		                            (case when (count(DISTINCT cash_id) filter (where itn in ('291267166'))is null) then 0 else count(DISTINCT cash_id) filter (where itn in ('291267166')) end) :: Decimal(10, 2) as gt_gratiafarm,
		                            (case when (count(DISTINCT cash_id) filter (where itn in ('190593725'))is null) then 0 else count(DISTINCT cash_id) filter (where itn in ('190593725')) end) :: Decimal(10, 2) as my_apteka,
		                            (case when (count(DISTINCT cash_id) filter (where itn in ('690594907'))is null) then 0 else count(DISTINCT cash_id) filter (where itn in ('690594907')) end) :: Decimal(10, 2) as eklinia,
		                            (case when (count(DISTINCT cash_id) filter (where itn in ('690025786'))is null) then 0 else count(DISTINCT cash_id) filter (where itn in ('690025786')) end) :: Decimal(10, 2) as novamedica,
		                            (case when (count(DISTINCT cash_id) filter (where itn in ('190549048'))is null) then 0 else count(DISTINCT cash_id) filter (where itn in ('190549048')) end) :: Decimal(10, 2) as medvaks

		                        from oplati_analytic.bi_organisation_payments bop
		                        left join oplati_analytic.spr_pos_area spa on bop.org_id =spa.org_id
		                        join oplati_analytic.spr_cashbox_area sca on sca.pos_id=spa.pos_id
		                        where sca.close_date is null
		                            and bop.type_name='Аптеки'
		                            and cash_id not in (
		                                select distinct bpt.device_id
		                                from oplati_analytic.bi_pos_type bpt
		                                left join oplati_analytic.bi_organisation_payments bop on bpt.org_id=bop.org_id
		                                where bop.type_name='Аптеки'
		                                    and status=1
		                            )
	                        )

	                        union all
                            
                            (
		                        select 
		                            today() - 1 as report_date,
		                            'Количество неактивных точек продаж' as parametr_type,
		                            (count(DISTINCT spa.pos_id)) :: Decimal(10, 2) as total,
		                            (case
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('100364237')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('100364237'))
		                            end) :: Decimal(10, 2) as belfarm,
		                            (case
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('200276523', '600013211', '300149691', '500059690', '700014653', '400022972'))
		                            end) :: Decimal(10,2) as belfarm_other,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('191063745','190431476')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('191063745','190431476'))
		                            end) :: Decimal(10,2) as zlist_inlek,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('391730131')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('391730131'))
		                            end) :: Decimal(10,2) as farmostrov,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('101376425','100751212')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('101376425','100751212'))
		                            end) :: Decimal(10,2) as remedika,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('300280870','390374811', '590004353','490001187','700232696')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('300280870','390374811', '590004353','490001187','700232696'))
		                            end) :: Decimal(10,2) as adel_dobrya,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('100456458', '191582872', '500221613', '190736275'))	is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('100456458', '191582872', '500221613', '190736275'))
		                            end) :: Decimal(10,2) as lybimy_pharm,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('192937675')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('192937675'))
		                            end) :: Decimal(10,2) as berejliv_pharm,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('193428904')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('193428904'))
		                            end) :: Decimal(10,2) as astrafarm,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('190317817','190646057','190649347', '190643591','491341877','391919271','193184069', '791238845','192828462'))
		                            end) :: Decimal(10,2) as ostrov_zdorovya,
		                            (case when (count(DISTINCT spa.pos_id) filter (where itn in ('193428904')) is null) then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('193428904'))end) :: Decimal(10, 2) as ligmaton,
		                            (case when (count(DISTINCT spa.pos_id) filter (where itn in ('291267166')) is null) then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('291267166'))end) :: Decimal(10, 2) as gt_gratiafarm,
		                            (case when (count(DISTINCT spa.pos_id) filter (where itn in ('190593725')) is null) then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('190593725'))end) :: Decimal(10, 2) as my_apteka,
		                            (case when (count(DISTINCT spa.pos_id) filter (where itn in ('690594907')) is null) then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('690594907'))end) :: Decimal(10, 2) as eklinia,
		                            (case when (count(DISTINCT spa.pos_id) filter (where itn in ('690025786')) is null) then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('690025786'))end) :: Decimal(10, 2) as novamedica,
		                            (case when (count(DISTINCT spa.pos_id) filter (where itn in ('190549048')) is null) then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('190549048'))end) :: Decimal(10, 2) as medvaks

		                        from oplati_analytic.bi_organisation_payments bop
		                        left join oplati_analytic.spr_pos_area spa on bop.org_id = spa.org_id
		                        join oplati_analytic.spr_cashbox_area sca on sca.pos_id = spa.pos_id
		                        where sca.close_date is null
		                            and bop.type_name='Аптеки'   
		                            and cash_id not in (
		                                select distinct bpt.device_id
		                                from oplati_analytic.bi_pos_type bpt
		                                left join oplati_analytic.bi_organisation_payments bop on bpt.org_id=bop.org_id
		                                where bop.type_name='Аптеки'
		                                and status=1
		                            )
		                            and spa.pos_id NOT IN (
		                                select DISTINCT pos_id
		                                from oplati_analytic.bi_pos_type
		                                where created_date >= '2022-01-01' 
		                            )
	                        )         
	          
	                        union all

	                        (
		                        select
		                            sc.calendar_date as report_date,
		                            parametr_type,
		                            unic_clients as total,
		                            null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null
		                        from oplati_analytic.spr_calendar sc
		                        right join(
		                            select 
		                                DATE_TRUNC('month', created_date::date) as t_date,
		                                'Количество пользователей(в месяц)'as parametr_type,
		                                (count(DISTINCT profile_id)) :: Decimal(10, 2) as unic_clients
		                            from oplati_analytic.bi_pos_type_2023 bpt
		                            left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                            left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                            where bop.type_name ='Аптеки' 
		                                and bpt.status=1
		                                and sca.close_date is null
		                                and date_trunc('month', created_date) = date_trunc('month', today()-1) 
		                            group by DATE_TRUNC('month', created_date::date)
		                            order by t_date desc
		                        ) date_cust
		                        on date_trunc('month', sc.calendar_date) = date_trunc('month', date_cust.t_date)
		                         and date_trunc('year', sc.calendar_date) = date_trunc('year', date_cust.t_date)  
		                        where date_trunc('day', sc.calendar_date::date) = date_trunc('day', today() - 1)
		                        order by sc.calendar_date asc
	                        )
                        ) phar
                        order by report_date,parametr_type asc;"

  "tab_bi_agr_partner_cashbox_monthly":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_partner_cashbox_monthly
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_partner_cashbox_monthly
                        select
	                        cash_cas.report_date,
	                        unp ,
	                        cash_id,
	                        reg_num,
	                        cash_cas.name as cashbox_name,
	                        cash_cas.cashbox_type,
	                        title,
	                        sum_operation,
	                        amount_operation
                        from (
	                        select
	                        	DATE_TRUNC('month', today() - 1) as report_date, cash_id,sca.name as name,reg_num,cashbox_type,unp,title
	                        from oplati_analytic.spr_cashbox_area sca 
	                        left join oplati_analytic.spr_pos_area spa 
	                        on sca.pos_id = spa.pos_id 
	                        left join oplati_analytic.bi_organisation bo 
	                        on spa.org_id = bo.profile_id
	                        where DATE_TRUNC('month', sca.open_date::date) <= DATE_TRUNC('month', today() - 1)
	                            and bo.unp in  ('101011505','800013732','190579561','100993744','192812526','190000087','191100860','191318808','192977976','190515685','190147296','190033145','190436996','491327524')
                        ) as cash_cas

                        left join (
	                        select
	                        	DATE_TRUNC('month', created_date) as report_date,
	                        	device_id,
	                        	sum(sum) as sum_operation,
	                        	count(*) as amount_operation
	                        from oplati_analytic.bi_pos_type_2023 
	                        where itn in  ('101011505','800013732','190579561','100993744','192812526','190000087','191100860','191318808','192977976','190515685','190147296','190033145','190436996','491327524')
	                        	and status = 1
	                        	and DATE_TRUNC('month', created_date) = DATE_TRUNC('month', today()-1)
	                        group by DATE_TRUNC('month', created_date),device_id
                        ) bpt
                        on cash_cas.cash_id = bpt.device_id and  cash_cas.report_date = bpt.report_date
                        order by report_date asc;"

  "tab_bi_agr_partner_check_monthly":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_partner_check_monthly
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_partner_check_monthly
                        select
	                        DATE_TRUNC('month', created_date) AS report_date,
	                        round(avg(sum) filter(where itn = '101011505'), 2) AS parimatch_avg_sum_operation,
	                        round(avg(sum) filter(where itn = '800013732'), 2)  AS mts_avg_sum_operation,
	                        round(avg(sum) filter(where itn = '190579561'), 2)  AS life_avg_sum_operation,
	                        round(avg(sum) filter(where itn = '100993744' and device_id in (12678, 63157)), 2)  AS slivki_avg_sum_operation,
	                        round(avg(sum) filter(where itn = '192812526' and device_id = 13850), 2)  AS erkom_avg_sum_operation,
	                        round(avg(sum) filter(where itn = '190000087'), 2)  AS belloto_avg_sum_operation,
	                        round(avg(sum) filter(where itn = '191100860'), 2)  AS lnumber_avg_sum_operation,
	                        round(avg(sum) filter(where itn = '191318808'), 2)  AS inho_avg_sum_operation,
	                        round(avg(sum) filter(where itn = '192977976'), 2)  AS bison_avg_sum_operation,
	
	                        round(count(distinct profile_id) filter(where itn = '101011505'), 2) AS parimatch_amount_customers,
	                        round(count(distinct profile_id) filter(where itn = '800013732'), 2)  AS mts_amount_customers,
	                        round(count(distinct profile_id) filter(where itn = '190579561'), 2)  AS life_amount_customers,
	                        round(count(distinct profile_id) filter(where itn = '100993744' and device_id in (12678, 63157)), 2)  AS slivki_amount_customers,
	                        round(count(distinct profile_id) filter(where itn = '192812526' and device_id = 13850), 2)  AS erkom_amount_customers,
	                        round(count(distinct profile_id) filter(where itn = '190000087'), 2)  AS belloto_amount_customers,
	                        round(count(distinct profile_id) filter(where itn = '191100860'), 2)  AS lnumber_amount_customers,
	                        round(count(distinct profile_id) filter(where itn = '191318808'), 2)  AS inho_amount_customers,
	                        round(count(distinct profile_id) filter(where itn = '192977976'), 2)  AS bison_amount_customers,
	                        round(avg(sum) filter(where itn = '190515685'), 2)  AS intercars__avg_sum_operation,
	                        round(count(distinct profile_id) filter(where itn = '190515685'), 2)  AS intercars_amount_customers,
	                        round(count(distinct profile_id) filter(where itn in('192977976','191318808','191100860','190000087','101011505','190147296','190033145','190436996')), 2)  AS amount_customers_gambling,
	
	                        round(count(distinct profile_id) filter(where itn in('800013732','190579561')), 2)  AS amount_customers_mobile,

	                        round(avg(sum) filter(where itn = '190147296'), 2) AS betcity_avg_sum_operation,
	                        round(count(distinct profile_id) filter(where itn = '190147296'), 2) AS betcity_amount_customers,
	
	                        round(avg(sum) filter(where itn = '190033145' and device_id = 48091), 2) AS lotoby_avg_sum_operation,
	                        round(count(distinct profile_id) filter(where itn = '190033145' and device_id = 48091), 2) AS lotoby_amount_customers,
	
	                        round(avg(sum) filter(where itn = '190436996' and device_id in (41319, 50670)), 2) AS marafon_avg_sum_operation,
	                        round(count(distinct profile_id) filter(where itn = '190436996' and device_id in (41319, 50670)), 2) AS marafon_amount_customers,
	
	                        round(avg(sum) filter(where itn = '491327524' and device_id in (54531, 51236)), 2) AS brazino777_avg_sum_operation,
	                        round(count(distinct profile_id) filter(where itn = '491327524' and device_id in (54531, 51236)), 2) AS brazino777_amount_customers
	
                        from oplati_analytic.bi_pos_type_2023 bpt
                        where 
	                        itn in  ('101011505','800013732','190579561','100993744','192812526','190000087','191100860','191318808','192977976','190515685','190147296','190033145','190436996','491327524') and   
	                        status=1   and
	                        DATE_TRUNC('month', created_date) = DATE_TRUNC('month', today() - 1)
                        group by DATE_TRUNC('month', created_date)
                        order by report_date asc;"

  "tab_bi_agr_partner_daily":
    clickhouse_query: "insert into oplati_views_report.bi_agr_partner_daily
                        select 
	                        report_date,
	                        (parimatch_sum_operation 
		                    + mts_sum_operation 
		                    + life_sum_operation 
		                    + slivki_sum_operation 
		                    + erkom_sum_operation 
		                    + belloto_sum_operation 
		                    + lnumber_sum_operation 
		                    + inho_sum_operation 
		                    + bison_sum_operation 
		                    + intercars_sum_operation
		                    + betcity_sum_operation
		                    + lotoby_sum_operation 
		                    + marafon_sum_operation 
		                    + brazino777_sum_operation
	                        ) as total_sum_operation,
	                        parimatch_sum_operation,
	                        parimatch_amount_operation,
	                        mts_sum_operation,
	                        mts_amount_operation,
	                        life_sum_operation,
	                        life_amount_operation,
	                        slivki_sum_operation,
	                        slivki_amount_operation,
	                        erkom_sum_operation,
	                        erkom_amount_operation,
	                        belloto_sum_operation,
	                        belloto_amount_operation,
	                        lnumber_sum_operation,
	                        lnumber_amount_operation,
	                        inho_sum_operation,
	                        inho_amount_operation,
	                        bison_sum_operation,
	                        bison_amount_operation,
	                        intercars_sum_operation,
	                        intercars_amount_operation,
	                        betcity_sum_operation,
	                        betcity_amount_operation,
	                        lotoby_sum_operation,
	                        lotoby_amount_operation,
	                        marafon_sum_operation,
	                        marafon_amount_operation,
	                        brazino777_sum_operation,
	                        brazino777_amount_operation
                        from (
                            select	
	                            DATE_TRUNC('day', created_date) AS report_date,
	                            
	                            round(sum(sum) filter(where itn = '101011505'), 2) AS parimatch_sum_operation,
	                            sum(case when itn = '101011505' then 1 else 0 end) AS parimatch_amount_operation,
	                            
	                            case 	
	                            	when round(sum(sum) filter(where itn = '800013732'), 2) is null then 0 
	                            	else round(sum(sum) filter(where itn = '800013732'), 2)
	                            end mts_sum_operation,
	                            sum(case when itn = '800013732' then 1 else 0 end) AS mts_amount_operation,
	                            
	                            case 	
	                            	when round(sum(sum) filter(where itn = '190579561'), 2) is null then 0 
	                            	else round(sum(sum) filter(where itn = '190579561'), 2)
	                            end as life_sum_operation,
	                            sum(case when itn = '190579561' then 1 else 0 end) AS life_amount_operation,
	                            
	                            round(sum(sum) filter(where itn = '100993744' and device_id in (12678, 63157)), 2)  AS slivki_sum_operation,
	                            sum(case when itn = '100993744' and device_id in (12678, 63157) then 1 else 0 end) AS slivki_amount_operation,
	                            
	                            case 	
	                            	when round(sum(sum) filter(where itn = '192812526' and device_id = 13850), 2) is null then 0 
	                            	else round(sum(sum) filter(where itn = '192812526' and device_id = 13850), 2)
	                            end AS erkom_sum_operation,
	                            sum(case when itn = '192812526'and device_id = 13850 then 1 else 0 end) AS erkom_amount_operation,
	                            
	                            round(sum(sum) filter(where itn = '190000087'), 2)  AS belloto_sum_operation,
	                            sum(case when itn = '190000087' then 1 else 0 end) AS belloto_amount_operation,
	                            
	                            round(sum(sum) filter(where itn = '191100860'), 2)  AS lnumber_sum_operation,
	                            sum(case when itn = '191100860' then 1 else 0 end) AS lnumber_amount_operation,
	                            
	                            
	                            round(sum(sum) filter(where itn = '191318808'), 2)  AS inho_sum_operation,
	                            sum(case when itn = '191318808' then 1 else 0 end) AS inho_amount_operation,
	                            
	                            round(sum(sum) filter(where itn = '192977976'), 2)  AS bison_sum_operation,
	                            sum(case when itn = '192977976' then 1 else 0 end) AS bison_amount_operation,
	                            
	                            case 	
	                            	when round(sum(sum) filter(where itn = '190515685' and device_id = 29409), 2) is null then 0 
	                            	else round(sum(sum) filter(where itn = '190515685' and device_id = 29409), 2) 
	                            end as intercars_sum_operation,
	                            sum(case when itn = '190515685' and device_id = 29409 then 1 else 0 end) AS intercars_amount_operation,
	                            
	                            case 	
	                            	when round(sum(sum) filter(where itn = '190147296'), 2) is null then 0 
	                            	else round(sum(sum) filter(where itn = '190147296'), 2)
	                            end betcity_sum_operation,
	                            sum(case when itn = '190147296'then 1 else 0 end) AS betcity_amount_operation,
	                            
	                            case 	
	                            	when round(sum(sum) filter(where itn = '190033145' and device_id = 48091), 2) is null then 0 
	                            	else round(sum(sum) filter(where itn = '190033145' and device_id = 48091), 2)
	                            end lotoby_sum_operation,
	                            sum(case when itn = '190033145' and device_id = 48091 then 1 else 0 end) AS lotoby_amount_operation,
	                            
	                            case 	
	                            	when round(sum(sum) filter(where itn = '190436996' and device_id in (41319, 50670)), 2) is null then 0 
	                            	else round(sum(sum) filter(where itn = '190436996' and device_id in (41319, 50670)), 2)
	                            end marafon_sum_operation,
	                            sum(case when itn = '190436996' and device_id in (41319, 50670) then 1 else 0 end) AS marafon_amount_operation,
	                            
	                            case 	
	                            	when round(sum(sum) filter(where itn = '491327524' and device_id  in (54531, 51236)), 2) is null then 0 
	                            	else round(sum(sum) filter(where itn = '491327524' and device_id  in (54531, 51236)), 2)
	                            end brazino777_sum_operation,
	                            sum(case when itn = '491327524' and device_id in (54531, 51236) then 1 else 0 end) AS brazino777_amount_operation
	
                            from oplati_analytic.bi_pos_type_2023 bpt
                            where 
	                            itn in ('101011505','800013732','190579561','100993744','192812526','190000087','191100860','191318808','192977976','190515685','190147296','190033145','190436996','491327524') 
	                             and status=1
	                             and created_date::date = today() - 1
                            group by DATE_TRUNC('day', created_date)
                            order by report_date asc
                        ) as t_partner
                        order by report_date asc;"

  "tab_bi_agr_horeca":
    clickhouse_query: "insert into oplati_views_report.bi_agr_horeca
                        select * from (
	                        (
	                            select 
	                                DATE_TRUNC('day', created_date) as report_date,
	                                'Суммы по операциям'as parametr_type,
	                                sum(bpt.sum) as total,
	                                (case
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('192360857')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('192360857'))
	                                end):: Decimal(10, 2) as dominos,
	                                (case
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('193280189')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('193280189'))
	                                end):: Decimal(10, 2) as cofix,
	                                (case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('192351693')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('192351693'))
	                                end):: Decimal(10, 2) as kfc,
	                                (case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('192415615','101316835')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('192415615','101316835'))
	                                end):: Decimal(10, 2) as burger_king,
	                                (case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('192740232')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('192740232'))
	                                end):: Decimal(10, 2) as tiery,
	                                (case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('192610415','193453737','192582165')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('192610415','193453737','192582165'))
	                                end):: Decimal(10, 2) as shous_fusion,
	                                (case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('193083807')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('193083807'))
	                                end):: Decimal(10, 2) as svesla,
	                                (case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('193491943'))is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('193491943'))
	                                end):: Decimal(10, 2) as terra_pizza,
	                                (case 
	                                	when (sum(bpt.sum) filter (where bpt.itn in ('193625656')) is null)
	                                	then 0 else sum(bpt.sum) filter (where bpt.itn in ('193625656'))
	                                end):: Decimal(10, 2) as chef_arts
	 
	                            from oplati_analytic.bi_pos_type_2023 bpt
	                            left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
	                            left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
	                            left join oplati_analytic.bi_transactions_refund btr on bpt.purchase_id =btr.operation_id
	                            where bop.type_name ='Кафе и рестораны' 
	                             and bpt.status=1
	                             and sca.close_date is null 
	                             and created_date::date = today() - 1
	                            group by DATE_TRUNC('day', created_date)
	                            order by report_date desc
	                        )
	
	                        union all
	                        (
		                        select 
		                            DATE_TRUNC('day', created_date) as report_date,
		                            'Количество операций'as parametr_type,
		                            (count(*)):: Decimal(10, 2) as total,
		                            (case
		                            	when (sum(case when bpt.itn in ('192360857') then 1 else 0 end) is null)
		                            	then 0 else sum (case when bpt.itn in ('192360857') then 1 else 0 end)
		                            end):: Decimal(10, 2) as dominos,
		                            (case
		                            	when (sum(case when bpt.itn in ('193280189') then 1 else 0 end)	is null)
		                            	then 0 else sum(case when bpt.itn in ('193280189') then 1 else 0 end)
		                            end):: Decimal(10, 2) as cofix,
		                            (case 
		                            	when (sum(case when bpt.itn in ('192351693') then 1 else 0 end)	is null)
		                            	then 0 else sum(case when bpt.itn in ('192351693') then 1 else 0 end)
		                            end):: Decimal(10, 2) as kfc,
		                            (case 
		                            	when (sum(case when bpt.itn in ('192415615','101316835') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('192415615','101316835') then 1 else 0 end)
		                            end):: Decimal(10, 2) as burger_king,
		                            (case 
		                            	when (sum(case when bpt.itn in ('192740232') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('192740232') then 1 else 0 end)
		                            end):: Decimal(10, 2) as tiery,
		                            (case 
		                            	when (sum(case when bpt.itn in ('192610415','193453737','192582165') then 1 else 0 end)	is null)
		                            	then 0 else sum(case when bpt.itn in ('192610415','193453737','192582165') then 1 else 0 end)
		                            end):: Decimal(10, 2) as shous_fusion,
		                            (case 
		                            	when (sum(case when bpt.itn in ('193083807') then 1 else 0 end)	is null)
		                            	then 0 else sum(case when bpt.itn in ('193083807') then 1 else 0 end)
		                            end):: Decimal(10, 2) as svesla,
		                            (case 
		                            	when (sum(case when bpt.itn in ('193491943') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('193491943') then 1 else 0 end)
		                            end):: Decimal(10, 2) as terra_pizza,
		                            (case 
		                            	when (sum(case when bpt.itn in ('193625656') then 1 else 0 end) is null)
		                            	then 0 else sum(case when bpt.itn in ('193625656') then 1 else 0 end)
		                            end):: Decimal(10, 2) as chef_arts
		
		                        from oplati_analytic.bi_pos_type_2023 bpt
		                        left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                        left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                        where bop.type_name ='Кафе и рестораны'  
		                         and bpt.status=1
		                         and sca.close_date is null
		                         and created_date::date = today()-1
		                        group by DATE_TRUNC('day', created_date)
		                        order by report_date desc
	                        )
	
	                        union all
	                        (
		                        select 
		                            DATE_TRUNC('day', created_date) as report_date,
		                            'Средний чек(в день)'as parametr_type,
		                            (round(avg(sum), 2)):: Decimal(10, 2) as total,
		                            (case
		                            	when (round(avg(sum)  filter (where bpt.itn in ('192360857')), 2) is null)
		                            	then 0 else round(avg(sum)  filter (where bpt.itn in ('192360857')), 2)
		                            end):: Decimal(10, 2) as dominos,
		                            (case
		                            	when (round(avg(sum) filter (where bpt.itn in ('193280189')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('193280189')), 2)
		                            end):: Decimal(10, 2) as cofix,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('192351693')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('192351693')), 2)
		                            end):: Decimal(10, 2) as kfc,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('192415615','101316835')), 2)is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('192415615','101316835')), 2)
		                            end):: Decimal(10, 2) as burger_king,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('192740232')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('192740232')), 2)
		                            end):: Decimal(10, 2) as tiery,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('192610415','193453737','192582165')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('192610415','193453737','192582165')), 2)
		                            end):: Decimal(10, 2) as shous_fusion,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('193083807')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('193083807')), 2)
		                            end):: Decimal(10, 2) as svesla,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('193491943')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('193491943')), 2)
		                            end):: Decimal(10, 2) as terra_pizza,
		                            (case 
		                            	when (round(avg(sum) filter (where bpt.itn in ('193625656')), 2) is null)
		                            	then 0 else round(avg(sum) filter (where bpt.itn in ('193625656')), 2)
		                            end):: Decimal(10, 2) as chef_arts
		
		                        from oplati_analytic.bi_pos_type_2023 bpt
		                        left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                        left join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                        where bop.type_name ='Кафе и рестораны' 
		                         and bpt.status=1
		                         and sca.close_date is null
		                         and created_date::date = today()-1
		                        group by DATE_TRUNC('day', created_date)
		                        order by report_date desc
	                        )
		
	                        union all
	                        (
		                        select
		                            sc.calendar_date as report_date,
		                            parametr_type,
		                            total,dominos,cofix,kfc,burger_king,tiery,shous_fusion,svesla,terra_pizza,chef_arts
		                        from oplati_analytic.spr_calendar sc
		                        right join(
		                            select 
		                                DATE_TRUNC('month', created_date) as t_date,
		                                'Средний чек(в месяц)'as parametr_type,
		                                (round(avg(sum), 2)):: Decimal(10, 2) as total,
		                                (case
		                                	when (round(avg(sum) filter (where bpt.itn in ('192360857')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('192360857')), 2)
		                                end):: Decimal(10, 2) as dominos,
		                                (case
		                                	when (round(avg(sum) filter (where bpt.itn in ('193280189')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('193280189')), 2)
		                                end):: Decimal(10, 2) as cofix,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('192351693')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('192351693')), 2)
		                                end):: Decimal(10, 2) as kfc,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('192415615','101316835')), 2)is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('192415615','101316835')), 2)
		                                end):: Decimal(10, 2) as burger_king,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('192740232')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('192740232')), 2)
		                                end):: Decimal(10, 2) as tiery,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('192610415','193453737','192582165')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('192610415','193453737','192582165')), 2)
		                                end):: Decimal(10, 2) as shous_fusion,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('193083807')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('193083807')), 2)
		                                end):: Decimal(10, 2) as svesla,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('193491943')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('193491943')), 2)
		                                end):: Decimal(10, 2) as terra_pizza,
		                                (case 
		                                	when (round(avg(sum) filter (where bpt.itn in ('193625656')), 2) is null)
		                                	then 0 else round(avg(sum) filter (where bpt.itn in ('193625656')), 2)
		                                end):: Decimal(10, 2) as chef_arts
		
		                            from oplati_analytic.bi_pos_type_2023 bpt
		                            left join oplati_analytic.bi_organisation_payments bop on bpt.org_id = bop.org_id 
		                            left join oplati_analytic.spr_cashbox_area sca on bpt.device_id = sca.cash_id
		                            where bop.type_name ='Кафе и рестораны' 
		                             and bpt.status = 1
		                             and sca.close_date is null
		                             and date_trunc('month', created_date :: date) = date_trunc('month', today() - 1) 
		                            group by DATE_TRUNC('month', created_date)
		                            order by t_date desc
		                        ) date_avg
		                        on date_trunc('month', sc.calendar_date) = date_trunc('month', date_avg.t_date)
		                         and date_trunc('year', sc.calendar_date) = date_trunc('year', date_avg.t_date)  
		                        where date_trunc('day', sc.calendar_date :: date) = date_trunc('day', today() - 1)
		                        order by sc.calendar_date asc
	                        )
		
	                        union all
                        	(
		                        select 
		                            today() - 1 as report_date,
		                            'Количество активных касс'as parametr_type,
		                            (count(DISTINCT device_id)) :: Decimal(10, 2) as total,
		                            (case
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('192360857')) is null )
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('192360857'))
		                            end) :: Decimal(10, 2) as dominos,
		                            (case
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('193280189') )	is null )
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('193280189'))
		                            end) :: Decimal(10, 2) as cofix,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('192351693'))	is null )
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('192351693'))
		                            end) :: Decimal(10, 2) as kfc,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('192415615','101316835'))is null )
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('192415615','101316835'))
		                            end) :: Decimal(10, 2) as burger_king,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('192740232')) is null )
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('192740232'))
		                            end) :: Decimal(10, 2) as tiery,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('192610415','193453737','192582165'))	is null )
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('192610415','193453737','192582165'))
		                            end) :: Decimal(10, 2) as shous_fusion,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('193083807'))	is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('193083807'))
		                            end) :: Decimal(10, 2) as svesla,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('193491943'))is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('193491943'))
		                            end) :: Decimal(10, 2) as terra_pizza,
		                            (case 
		                            	when (count(DISTINCT device_id) filter (where bpt.itn in ('193625656','192518888')) is null)
		                            	then 0 else count(DISTINCT device_id) filter (where bpt.itn in ('193625656','192518888'))
		                            end) :: Decimal(10, 2) as chef_arts
		
		                        from oplati_analytic.bi_pos_type bpt
		                        left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                        join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                        where bop.type_name ='Кафе и рестораны'  
		                         and bpt.status=1
		                         and sca.close_date is null
	                        )
		
	                        union all
	                        (
			                    select 
		                            today() - 1 as report_date,
		                            'Количество активных точек продаж'as parametr_type,
		                            (count(DISTINCT bpt.pos_id)) :: Decimal(10, 2) as total,
		                            (case
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192360857')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192360857'))
		                            end) :: Decimal(10, 2) as dominos,
		                            (case
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193280189')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193280189'))
		                            end) :: Decimal(10, 2) as cofix,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192351693')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192351693'))
		                            end) :: Decimal(10, 2) as kfc,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192415615','101316835')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192415615','101316835'))
		                            end) :: Decimal(10, 2) as burger_king,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192740232')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192740232'))
		                            end) :: Decimal(10, 2) as tiery,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192610415','193453737','192582165')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('192610415','193453737','192582165'))
		                            end) :: Decimal(10, 2) as shous_fusion,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193083807')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193083807'))
		                            end) :: Decimal(10, 2) as svesla,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193491943')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193491943'))
		                            end) :: Decimal(10, 2) as terra_pizza,
		                            (case 
		                            	when (count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193625656','192518888')) is null)
		                            	then 0 else count(DISTINCT bpt.pos_id) filter (where bpt.itn in ('193625656','192518888'))
		                            end) :: Decimal(10, 2) as chef_arts
		
		                        from oplati_analytic.bi_pos_type bpt
		                        left join oplati_analytic.bi_organisation_payments bop on bpt.org_id =bop.org_id 
		                        join oplati_analytic.spr_cashbox_area sca on bpt.device_id=sca.cash_id
		                        where bop.type_name ='Кафе и рестораны'  
		                         and bpt.status=1
		                         and sca.close_date is null
	                        ) 
	
	                        union all
	                        (
		                        select 
		                            today() - 1 as report_date,
		                            'Количество неактивных касс'as parametr_type,
		                            (count(DISTINCT cash_id)) :: Decimal(10, 2) as total,
		                            (case
		                            	when (count(DISTINCT cash_id) filter (where itn in ('192360857')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('192360857'))
		                            end) :: Decimal(10, 2) as dominos,
		                            (case
		                            	when (count(DISTINCT cash_id) filter (where itn in ('193280189')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('193280189'))
		                            end) :: Decimal(10, 2) as cofix,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('192351693')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('192351693'))
		                            end) :: Decimal(10, 2) as kfc,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('192415615','101316835')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('192415615','101316835'))
		                            end) :: Decimal(10, 2) as burger_king,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('192740232')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('192740232'))
		                            end) :: Decimal(10, 2) as tiery,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('192610415','193453737','192582165')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('192610415','193453737','192582165'))
		                            end) :: Decimal(10, 2) as shous_fusion,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('193083807')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('193083807'))
		                            end) :: Decimal(10, 2) as svesla,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('193491943')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('193491943'))
		                            end) :: Decimal(10, 2) as terra_pizza,
		                            (case 
		                            	when (count(DISTINCT cash_id) filter (where itn in ('193625656','192518888')) is null)
		                            	then 0 else count(DISTINCT cash_id) filter (where itn in ('193625656','192518888'))
		                            end) :: Decimal(10, 2) as chef_arts
		
		                        from oplati_analytic.bi_organisation_payments bop
		                        left join oplati_analytic.spr_pos_area spa on bop.org_id =spa.org_id
		                        join oplati_analytic.spr_cashbox_area sca on sca.pos_id=spa.pos_id
		                        where sca.close_date is null
		                            and bop.type_name='Кафе и рестораны'
		                            and cash_id not in (
		     	                        select distinct bpt.device_id
		                                from oplati_analytic.bi_pos_type bpt
		                                left join oplati_analytic.bi_organisation_payments bop on bpt.org_id=bop.org_id
		                                where bop.type_name='Кафе и рестораны'
		                                 and status=1  
		   	                        )
	                        )
		
	                        union all
	                        (
		                        select 
		                            today() - 1 as report_date,
		                            'Количество неактивных точек продаж'as parametr_type,
		                            (count(DISTINCT spa.pos_id)) :: Decimal(10, 2) as total,
		                            (case
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('192360857')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('192360857'))
		                            end) :: Decimal(10, 2) as dominos,
		                            (case
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('193280189') ) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('193280189'))
		                            end) :: Decimal(10, 2) as cofix,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('192351693')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('192351693'))
		                            end) :: Decimal(10, 2) as kfc,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('192415615','101316835')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('192415615','101316835'))
		                            end) :: Decimal(10, 2) as burger_king,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('192740232')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('192740232'))
		                            end) :: Decimal(10, 2) as tiery,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('192610415','193453737','192582165')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('192610415','193453737','192582165'))
		                            end) :: Decimal(10, 2) as shous_fusion,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('193083807')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('193083807'))
		                            end) :: Decimal(10, 2) as svesla,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('193491943')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('193491943'))
		                            end) :: Decimal(10, 2) as terra_pizza,
		                            (case 
		                            	when (count(DISTINCT spa.pos_id) filter (where itn in ('193625656','192518888')) is null)
		                            	then 0 else count(DISTINCT spa.pos_id) filter (where itn in ('193625656','192518888'))
		                            end) :: Decimal(10, 2) as chef_arts
		
		                        from oplati_analytic.bi_organisation_payments bop
		                        left join oplati_analytic.spr_pos_area spa on bop.org_id =spa.org_id
		                        join oplati_analytic.spr_cashbox_area sca on sca.pos_id=spa.pos_id
		                        where sca.close_date is null
		                         and bop.type_name='Кафе и рестораны'
		                         and cash_id not in (
		                            select distinct bpt.device_id
		                            from oplati_analytic.bi_pos_type bpt
		                            left join oplati_analytic.bi_organisation_payments bop on bpt.org_id=bop.org_id
		                            where bop.type_name='Кафе и рестораны'
		                             and status=1
		                        )
		                        and spa.pos_id NOT IN (
		 	                        select DISTINCT pos_id
		                            from oplati_analytic.bi_pos_type
		                            where created_date >= '2022-01-01' 
		                        )
	                        )         
	          	   
	                        union all
	                        (
		                        select
		                            sc.calendar_date as report_date,
		                            parametr_type,
		                            unic_clients as total,
		                            null,null,null,null,null,null,null,null,null
		                        from oplati_analytic.spr_calendar sc
		                        right join(
		                            select 
		                                DATE_TRUNC('month', created_date) as t_date,
		                                'Количество пользователей(в месяц)'as parametr_type,
		                                (count(DISTINCT profile_id)) :: Decimal(10, 2) as unic_clients
		                            from oplati_analytic.bi_pos_type_2023 bpt
		                            left join oplati_analytic.bi_organisation_payments bop on bpt.org_id = bop.org_id 
		                            left join oplati_analytic.spr_cashbox_area sca on bpt.device_id = sca.cash_id
		                            where bop.type_name ='Кафе и рестораны' 
		                             and bpt.status=1
	 	                             and sca.close_date is null
		                             and date_trunc('month', created_date::date) = date_trunc('month', today() - 1) 
		                            group by DATE_TRUNC('month', created_date)
		                            order by t_date asc
		                        ) date_cust
		                        on date_trunc('month', sc.calendar_date) = date_trunc('month', date_cust.t_date)
		                         and date_trunc('year', sc.calendar_date) = date_trunc('year', date_cust.t_date)  
		                        where date_trunc('day', sc.calendar_date :: date) = date_trunc('day', today() - 1)
		                        order by sc.calendar_date ASC
	                        )
                        ) phar
                        order by report_date,parametr_type asc;"

  "tab_bi_agr_horeca_active":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_horeca_active
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into  oplati_views_report.bi_agr_horeca_active
                        SELECT 
	                        today() - 1 as report_date,	
	                        bpt.name AS name,
                            bpt.itn AS itn,
                            bpt.pos_name AS pos_name,
                            bpt.city AS city,
                            bpt.region AS region,
                            sca.reg_num AS reg_num,
                            count (distinct purchase_id) filter (where created_date >= date_trunc('month', today()) - interval '1 month' and created_date < date_trunc('month', today())) AS amount_prev_month,
                            case
                            	when sum(bpt.sum) filter (where created_date >= date_trunc('month', today()) - interval '1 month' and created_date < date_trunc('month', today())) is NULL then 0
                                else sum(bpt.sum) filter (where created_date >= date_trunc('month', today()) - interval '1 month' and created_date < date_trunc('month', today()))
                            end as sum_prev_month,
                            avg(bpt.sum) as avg_check_prev_month,
                            count(DISTINCT purchase_id) as total_amount,
                            case
                            	when sum(bpt.sum) is NULL then 0
                                else sum(bpt.sum)
                            end as total_sum,
                            case
                            	when avg(bpt.sum) is NULL then 0
                                else avg(bpt.sum)
                            end as toatl_avg_check,
                            count(DISTINCT operation_id) as total_amount_ref,
                            case
                            	when SUM(btr.sum) is NULL then 0
                                else SUM(btr.sum)
                            end as total_sum_ref
                        from oplati_analytic.bi_pos_type bpt
                        left join oplati_analytic.bi_organisation_payments bop on bpt.itn=bop.itn
                        join oplati_analytic.spr_cashbox_area sca on bpt.device_id = sca.cash_id
                        left join oplati_analytic.bi_transactions_refund btr on bpt.purchase_id = btr.operation_id
                        where bop.type_name = 'Кафе и рестораны'
	                        and bpt.status = 1
                            and sca.close_date is null
                        GROUP BY bpt.name,
                            bpt.itn,
                            bpt.pos_name,
                            bpt.city,
                            bpt.region,
                            sca.reg_num
                        ORDER BY sum(bpt.sum) desc;"

  "tab_bi_agr_horeca_inactive":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_horeca_inactive
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_horeca_inactive
                        select 
	                        today() - 1 as report_date,
	                        bop.name AS name,
	                        bop.itn AS itn,
	                        spa.pos_name AS pos_name,
	                        sca.reg_num AS reg_num,
	                        spa.city AS city,
	                        spa.region AS region       
                        from oplati_analytic.bi_organisation_payments bop
                        left join oplati_analytic.spr_pos_area spa on bop.org_id =spa.org_id
                        join oplati_analytic.spr_cashbox_area sca on sca.pos_id=spa.pos_id
                        where sca.close_date is null
	                     and bop.type_name='Кафе и рестораны'
	                     and cash_id not in (
		                    select distinct bpt.device_id
		                    from oplati_analytic.bi_pos_type bpt
		                    left join oplati_analytic.bi_organisation_payments bop on bpt.org_id=bop.org_id
		                    where bop.type_name='Кафе и рестораны'
		                     and status=1
                        );"

  "tab_bi_agr_direction_indicators":
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_indicators
                        select 
	                        tot_d.report_date,
	                        catalog_organisation,
	                        catalog_cashbox,
	                        catalog_active_organisation,
	                        catalog_active_cashbox,
	                        total_vend_organisation,
	                        total_vend_cashbox,
	                        total_vend_active_organisation,
	                        total_vend_active_cashbox,
	                        vodomat_organisation,
	                        vodomat_active_organisation,
	                        vodomat_cashbox,
	                        vodomat_active_cashbox,
	                        vending_organisation,
	                        vending_active_organisation,
	                        vending_cashbox,
	                        vending_active_cashbox,
	                        entertainment_organisation,
	                        entertainment_cashbox,
	                        entertainment_active_organisation,
	                        entertainment_active_cashbox,
	                        integrated_site_organisation,
	                        integrated_site_cashbox,
	                        integrated_site_active_organisation,
	                        integrated_site_active_cashbox,
	                        carwash_cashbox,
	                        carwash_amount,
	                        carwash_active_amount,
	                        carwash_active_cashbox,
	                        other_entertainment_organisation,
	                        other_entertainment_cashbox,
	                        other_entertainment_active_organisation,
	                        other_entertainment_active_cashbox,
	                        other_entertainment_inactive_cashbox,
	                        other_entertainment_active_pos,
	                        other_entertainment_inactive_pos,
	                        education_organisation,
	                        education_cashbox,
	                        education_active_organisation,
	                        education_active_cashbox,
	                        education_cashbox - education_active_cashbox as education_inactive_cashbox,
	                        education_pos,
	                        education_active_pos,
	                        education_pos - education_active_pos as education_inactive_pos,
	                        education_sum_day,
	                        education_avg_check
                        from (
	                        select 
	                        	today() - 1 as report_date,
	                        	count(distinct bop.company_id) as catalog_organisation ,
	                        	count(t4.cash_id) as catalog_cashbox
	                        from oplati_analytic.spr_poi_app t1
	                        left join oplati_analytic.spr_poi_app_channels t2
	                        on t1.id=t2.app_id
	                        left join oplati_analytic.spr_poi_app_category t3
	                        on t1.category_id=t3.id
	                        join oplati_analytic.spr_cashbox_area t4
	                        on t2.cashbox_number=t4.reg_num 
	                        left join oplati_analytic.spr_pos_area spa
	                        on t4.pos_id = spa.pos_id
	                        left join oplati_analytic.bi_organisation_payments bop 
	                        on bop.org_id = spa.org_id 
	                        where t1.deleted_at is null and t4.close_date is null and t4.open_date is not NULL
                        ) tot_d

                        left join (
	                        select 
	                        	today() - 1 as report_date,
	                        	count(distinct bpt.org_id) as catalog_active_organisation,
	                        	count(distinct bpt.device_id) as catalog_active_cashbox  
	                        from oplati_analytic.bi_pos_type bpt 
	                        left join oplati_analytic.spr_cashbox_area t4
	                        on bpt.device_id = t4.cash_id 
	                        right join oplati_analytic.spr_poi_app_channels t2
	                        on t2.cashbox_number=t4.reg_num 
	                        right join oplati_analytic.spr_poi_app t1
	                        on t1.id=t2.app_id
	                        left join oplati_analytic.spr_poi_app_category t3
	                        on t1.category_id=t3.id
	                        left join oplati_analytic.spr_pos_area spa
                            on t4.pos_id=spa.pos_id
                            left join oplati_analytic.bi_organisation_payments bop 
                            on bop.org_id =spa.org_id 
	                        where deleted_at is null and t4.close_date is null and t4.open_date is not NULL
                        )catalog_act
                        on tot_d.report_date = catalog_act.report_date

                        left join (
                        	select 
                        		today() - 1 as report_date,
                        		count(distinct bo.profile_id) as total_vend_organisation,
                        		count(distinct bo.profile_id) filter (where bo.\"name\" = 'Вендинговые аппараты') as vending_organisation,
                        		count(distinct bo.profile_id) filter (where bo.\"name\" = 'Водоматы') as vodomat_organisation,
                        		count(sca.cash_id) filter (where sca.close_date is null ) as total_vend_cashbox,
                        		count(sca.cash_id) filter (where sca.close_date is null and bo.\"name\" = 'Водоматы') as vodomat_cashbox,
                        		count(sca.cash_id) filter (where sca.close_date is null and bo.\"name\" = 'Вендинговые аппараты') as vending_cashbox
                        	from oplati_analytic.bi_organisation bo 
                        	right join oplati_analytic.spr_pos_area spa 
                        	on bo.profile_id = spa.org_id 
                        	right join oplati_analytic.spr_cashbox_area sca  
                        	on sca.pos_id = spa.pos_id 
                        	where bo.\"name\" in ('Вендинговые аппараты', 'Водоматы')
                        ) t_vend
                        on tot_d.report_date = t_vend.report_date

                        left join (
                        	select 
	                            	today() - 1 as report_date,
                                	count(distinct bpt.org_id) filter (where bo.name in ('Вендинговые аппараты', 'Водоматы')) as total_vend_active_organisation,
                                	count(distinct bpt.device_id) filter (where sca.close_date is null and bo.name in ('Вендинговые аппараты', 'Водоматы')) as total_vend_active_cashbox,  	
    
                                	count(distinct bpt.org_id) filter (where bo.name = 'Вендинговые аппараты') as vending_active_organisation,
                                	count(distinct bpt.org_id) filter (where bo.name = 'Водоматы') as vodomat_active_organisation,
    
                                	count(distinct bpt.device_id) filter (where bo.name = 'Вендинговые аппараты' and sca.close_date is null) as vending_active_cashbox,
                                	count(distinct bpt.device_id) filter (where bo.name = 'Водоматы' and sca.close_date is null) as vodomat_active_cashbox
    
                            	from oplati_analytic.bi_pos_type bpt
                            	left join oplati_analytic.bi_organisation bo
                            	on bpt.org_id = bo.profile_id
                            	left join oplati_analytic.spr_cashbox_area sca
                            	on bpt.device_id = sca.cash_id 
                            	where bo.name in ('Вендинговые аппараты', 'Водоматы') and status  = 1 
                        ) act_vend
                        on tot_d.report_date = act_vend.report_date

                        left join (
                        	select
                        		act_ent.report_date,
                        		entertainment_organisation,
                        		entertainment_cashbox,
                        		entertainment_active_organisation,
                        		entertainment_active_cashbox,
                        		other_entertainment_organisation,
                        		other_entertainment_cashbox,
                        		other_entertainment_active_organisation,
                        		other_entertainment_active_cashbox,
                        		other_entertainment_cashbox - other_entertainment_active_cashbox as other_entertainment_inactive_cashbox,
                        		other_entertainment_active_pos,
                        		other_entertainment_pos - other_entertainment_active_pos as other_entertainment_inactive_pos
                        	from (
                        		SELECT 
                        			today() - 1 as report_date,
                        		 	count(distinct company_id) AS entertainment_active_organisation,
                        			count(distinct cashid) AS entertainment_active_cashbox,
                        			count(distinct company_id) filter (where company_id = 754023) AS other_entertainment_active_organisation,
                        			count(distinct cashid) filter (where company_id = 754023) AS other_entertainment_active_cashbox,
                        			count(distinct spa.pos_id) filter (where ttt.company_id = 754023) AS other_entertainment_active_pos
                        		FROM oplati_analytic.bi_entertainment_ticket ttt
                        		left join oplati_analytic.spr_cashbox_area sca
                        		on sca.cash_id = ttt.cashid 
                        		left join oplati_analytic.spr_pos_area spa 
                        		on sca.pos_id = spa.pos_id 
                        		where (status = 'BUY') 
                        	) act_ent

	                        left join (
	                        	SELECT 
	                        		today() - 1 as report_date,
	                        		count(distinct pp.company_id) AS entertainment_organisation,
	                        		count(distinct pp.cash_id) AS entertainment_cashbox,
	                        		count(distinct pp.company_id) filter (where pp.company_id = 754023) AS other_entertainment_organisation,
	                        		count(distinct pp.cash_id) filter (where pp.company_id = 754023) AS other_entertainment_cashbox,
	                        		count(distinct spa.pos_id) filter (where pp.company_id = 754023) AS other_entertainment_pos
	                        	FROM oplati_analytic.spr_entertainment_point pp
	                        	right join oplati_analytic.bi_organisation bo 
	                        	on bo.profile_id  = pp.company_id 
	                        	left join oplati_analytic.spr_pos_area spa 
	                        	on bo.profile_id = spa.org_id 
	                        	left join oplati_analytic.spr_cashbox_area sca
	                        	on sca.pos_id = spa.pos_id 
	                        )t_ent
	                        on act_ent.report_date = t_ent.report_date

                        )f_ent
                        on tot_d.report_date = f_ent.report_date
						
                        
                        left join (
                        	select 
                        		today() - 1 as report_date,
                        		count(distinct org_id) as integrated_site_organisation
                        	from oplati_analytic.spr_pos_area spa 
                        	where pos_id in (
                        		select distinct pos_id from oplati_analytic.spr_cashbox_area 
                        		where reg_num in (
                        			select reg_num from (
                        				select * from (
                        					select reg_num
                        					from oplati_analytic.bi_organisation_payments bop 
                        					left join oplati_analytic.spr_pos_area spa
                        					on bop.org_id =spa.org_id 
                        					left join oplati_analytic.spr_cashbox_area sca
                        					on sca.pos_id=spa.pos_id
                        					where  bop.org_id not in (
                        						613278,311490,73670,134259,
                        						141122,155007,168413,173531,218394,223318,228876,233174,233184,235296,237365,
                        						240479,244250,244253,245985,249123,249921,253424,253475,254145,257255,257324,
                        						257684,257869,260198,260230,261349,264486,268937,269657,271762,272622,275136,
                        						277032,282822,283466,289171,289206,293619,296201,297026,299674,299721,302694,
                        						302704,306193,307979,310841,311310,312584,316047,320383,321239,331515,333889,
                        						333895,333933,340333,347507,347563,352317,355739,355844,357260,357276,361937,
                        						366062,367586,370160,370813,373117,373121,373653,373792,373813,374354,374500,
                        						378586,379133,379143,380597,382895,386232,388455,389687,390667,393363,420876,
                        						429226,429267,436599,457863,460856,464337,465095,486361,511141,517442,519131,
                        						525118,526305,534824,539022,54305,544949,546538,552659,552989,557715,557971,
                        						574266,605268,606533,622793,631426,633700,634415,646060,647029,652950,653266,653274,
                        						656376,657019,657992,659001,659009,659676,663924,664652,668843,669094,684326,684518,
                        						701745,77790) and sca.cashbox_type=3 
                        					and type_name not in ( 'Пассажирские перевозки','Вендинговые аппараты', 'АЗС', 'Водоматы', 'Автомойки')
                        					and itn <>'192812526' and itn<>'100993744'
                        					and itn<>'193009535' and itn<>'102391623'
                        					and sca.cash_id<>6112 and sca.cash_id<>9411
                        					and sca.close_date is null
                        				) ddd
                        				left join oplati_analytic.spr_poi_app_channels ttt
                        				on ddd.reg_num = ttt.cashbox_number 
                        			) aa where id = 0
                        		)
                        	)
                        ) integr_s
                        on tot_d.report_date = integr_s.report_date
						
                        left join (
                        	select 
                        		today() - 1 as report_date,
                        		count(distinct cash_id)  as integrated_site_cashbox
                        	from oplati_analytic.spr_cashbox_area 
                        	where reg_num in (
                        		select reg_num from (
                        			select * from (
                        				select reg_num
                        				from oplati_analytic.bi_organisation_payments bop 
                        				left join oplati_analytic.spr_pos_area spa
                        				on bop.org_id =spa.org_id 
                        				left join oplati_analytic.spr_cashbox_area sca
                        				on sca.pos_id=spa.pos_id
                        				where  bop.org_id not in (
                        					613278,311490,73670,134259,615279,
                        					141122,155007,168413,173531,218394,223318,228876,233174,233184,235296,237365,
                        					240479,244250,244253,245985,249123,249921,253424,253475,254145,257255,257324,
                        					257684,257869,260198,260230,261349,264486,268937,269657,271762,272622,275136,
                        					277032,282822,283466,289171,289206,293619,296201,297026,299674,299721,302694,
                        					302704,306193,307979,310841,311310,312584,316047,320383,321239,331515,333889,
                        					333895,333933,340333,347507,347563,352317,355739,355844,357260,357276,361937,
                        					366062,367586,370160,370813,373117,373121,373653,373792,373813,374354,374500,
                        					378586,379133,379143,380597,382895,386232,388455,389687,390667,393363,420876,
                        					429226,429267,436599,457863,460856,464337,465095,486361,511141,517442,519131,
                        					525118,526305,534824,539022,54305,544949,546538,552659,552989,557715,557971,
                        					574266,605268,606533,622793,631426,633700,634415,646060,647029,652950,653266,653274,
                        					656376,657019,657992,659001,659009,659676,663924,664652,668843,669094,684326,684518,
                        					701745,77790) and sca.cashbox_type=3 
                        				and type_name not in ( 'Пассажирские перевозки','Вендинговые аппараты', 'АЗС', 'Водоматы', 'Автомойки')
                        				and itn <>'192812526' and itn<>'100993744'
                        				and itn<>'193009535' and itn<>'102391623'
                        				and sca.cash_id<>6112 and sca.cash_id<>9411
                        				and sca.close_date is null
                        			) ddd
                        		left join oplati_analytic.spr_poi_app_channels ttt
                        		on ddd.reg_num = ttt.cashbox_number 
                        		) aa where id = 0
                        	)
                        ) integr_cas
                        on tot_d.report_date = integr_cas.report_date
						
						
                        left join (
                        	select 
                        		today() - 1 as report_date,
                        		count(distinct device_id) as integrated_site_active_cashbox  ,
                        		count(distinct org_id) as integrated_site_active_organisation 
                        	from oplati_analytic.bi_pos_type 
                        	where status = 1 and device_id in (
                        		select distinct cash_id from oplati_analytic.spr_cashbox_area
                        		where reg_num in (
                        			select reg_num from (
                        				select * from (
                        					select reg_num
                        					from oplati_analytic.bi_organisation_payments bop 
                        					left join oplati_analytic.spr_pos_area spa
                        					on bop.org_id =spa.org_id 
                        					left join oplati_analytic.spr_cashbox_area sca
                        					on sca.pos_id=spa.pos_id
                        					where bop.org_id not in (
                        						613278,311490,73670,134259,615279,
                        						141122,155007,168413,173531,218394,223318,228876,233174,233184,235296,237365,
                        						240479,244250,244253,245985,249123,249921,253424,253475,254145,257255,257324,
                        						257684,257869,260198,260230,261349,264486,268937,269657,271762,272622,275136,
                        						277032,282822,283466,289171,289206,293619,296201,297026,299674,299721,302694,
                        						302704,306193,307979,310841,311310,312584,316047,320383,321239,331515,333889,
                        						333895,333933,340333,347507,347563,352317,355739,355844,357260,357276,361937,
                        						366062,367586,370160,370813,373117,373121,373653,373792,373813,374354,374500,
                        						378586,379133,379143,380597,382895,386232,388455,389687,390667,393363,420876,
                        						429226,429267,436599,457863,460856,464337,465095,486361,511141,517442,519131,
                        						525118,526305,534824,539022,54305,544949,546538,552659,552989,557715,557971,
                        						574266,605268,606533,622793,631426,633700,634415,646060,647029,652950,653266,653274,
                        						656376,657019,657992,659001,659009,659676,663924,664652,668843,669094,684326,684518,
                        						701745,77790) and sca.cashbox_type=3 
                        					and type_name not in ( 'Пассажирские перевозки','Вендинговые аппараты', 'АЗС', 'Водоматы', 'Автомойки')
                        					and itn <>'192812526' and itn<>'100993744'
                        					and itn<>'193009535' and itn<>'102391623'
                        					and sca.cash_id<>6112 and sca.cash_id<>9411
                        					and sca.close_date is null
                        				) ddd
                        				left join oplati_analytic.spr_poi_app_channels ttt
                        				on ddd.reg_num = ttt.cashbox_number 
                        			) aa where id = 0
                        		)
                        	)
                        ) integr_act_cash
                        on tot_d.report_date = integr_act_cash.report_date
						
                        left join (
                        	select 
                        		today() - 1 as report_date,
                        		count(distinct sc.cash_id) as carwash_amount, 
                        		count (distinct company_id) as carwash_cashbox  
                        	from oplati_analytic.spr_cashbox_area  bo 
                        	right join oplati_analytic.spr_carwash sc
                        	on bo.cash_id = sc.cash_id where bo.close_date is null and company_id is not null 
                        )carw_t
                        on tot_d.report_date = carw_t.report_date

                        left join (
                        	select 
                        		today() - 1 as report_date,
                        		count(distinct company_id) as carwash_active_amount,
                        		count(distinct sc.cash_id) as carwash_active_cashbox 
                        	from oplati_analytic.bi_pos_type bpt 
                        	left join oplati_analytic.spr_carwash sc
                        	on bpt.org_id = sc.company_id 
                        	left join oplati_analytic.spr_cashbox_area  bo 
                        	on bo.cash_id = sc.cash_id 
                        	where bo.close_date is null
                        )carw_act
                        on tot_d.report_date = carw_act.report_date
						
                        left join(
                        	select 
	                            today()-1 as report_date,
	                            count(distinct bop.company_id) as education_organisation ,
	                            count(sca.cash_id) as education_cashbox,
	                            count(distinct spa.pos_id) as education_pos
                            from oplati_analytic.spr_pos_area spa
                            left join oplati_analytic.spr_cashbox_area sca 
                            on spa.pos_id = sca.pos_id 
                            left join oplati_analytic.bi_organisation_payments bop 
                            on bop.org_id = spa.org_id 
                            where spa.close_date is null
                                and bop.itn in (
	                                '193775597', '193578419', '491702640', '391942045', '391107791', '193750099', '591970689', '391016033', '192813839',
	                                '191376663', '291754200', '591908766', '491387354', '291800587', '391939022', '193717440', '192972392', '193749492',
	                                '693326300', '193733821', '791347435', '193745308', '193282429', '791351441', '791351495', '291820897', '191275500',
	                                '491345076', '193109714', '691647647', '591757265', '193688337', '193680004', '193679265', '491606786', '791193624',
	                                '193309996', '193698816', '192525546', '193292872', '791349070', '192531356', '291615087', '291830355', '491656083',
	                                '193702738', '691644081', '193703484', '193664723', '193652823', '193669010', '591044914', '591044649', '591044702',
	                                '591044598', '591044608', '291769444', '791344224', '193665638', '791344303', '100904785', '391776109', '491382906',
	                                '791320332', '391785954', '192035737', '193686319', '391935892', '291809410', '600183248', '591043310', '193642040',
	                                '491627972', '193632899', '192607977', '193589869', '193671938', '491674467', '491336836', '193664205', '193577282',
	                                '192322903', '692258561', '391809139', '192592246', '391840672', '491335416', '491546336', '193651393', '193641108',
	                                '391841533', '691977970', '193643593', '491546004', '791296708', '791280195', '790827061', '192533425', '192031320',
	                                '491528136', '192978150', '192014951', '591039955', '192426307', '491592102', '691914529', '491052840', '591037383',
	                                '491227771', '692197924', '791222845', '692188625', '193495007', '191451701', '193562620', '591708089', '791279254',
	                                '193592613', '193154604', '291707808', '193454177', '190908260', '491429180', '391853617', '590373024', '591182174',
	                                '491227598', '591273983', '491526105', '700192265', '490963626', '192237146', '193139735', '291546997', '391271602',
	                                '790916809', '391309767', '191274599', '193125327', '791021927', '491065351', '191442721', '600102127', '490320109',
	                                '192671808', '201031439', '192538626', '291510978', '590767974', '192011222', '691720141', '191435318', '791189128',
	                                '500134647', '291660880', '491411744', '591033362', '391813104', '791025100', '101522289', '791066714', '191308663',
	                                '100582412', '691587598', '791107636', '192716860', '500065801', '391726602', '100124517', '500016985', '490858817',
	                                '290473286', '391810424', '191150091', '290983548', '290983507', '100027735', '192075193', '600095711', '200244780',
	                                '700181333', '600042065', '390540824', '691795399', '191106976', '500161273', '190639771', '101117830', '390540865')
                        ) t_edu
                        on tot_d.report_date = t_edu.report_date

                        left join (
                        		select 
		                            today()-1 as report_date,
		                            count(distinct bpt.org_id) as education_active_organisation,
		                            count(distinct bpt.device_id) as education_active_cashbox,
		                            count(distinct bpt.pos_id) as education_active_pos
	                            from oplati_analytic.bi_pos_type bpt 
	                            where bpt.itn in (
		                            '193775597', '193578419', '491702640', '391942045', '391107791', '193750099', '591970689', '391016033', '192813839',
		                            '191376663', '291754200', '591908766', '491387354', '291800587', '391939022', '193717440', '192972392', '193749492',
		                            '693326300', '193733821', '791347435', '193745308', '193282429', '791351441', '791351495', '291820897', '191275500',
		                            '491345076', '193109714', '691647647', '591757265', '193688337', '193680004', '193679265', '491606786', '791193624',
		                            '193309996', '193698816', '192525546', '193292872', '791349070', '192531356', '291615087', '291830355', '491656083',
		                            '193702738', '691644081', '193703484', '193664723', '193652823', '193669010', '591044914', '591044649', '591044702',
		                            '591044598', '591044608', '291769444', '791344224', '193665638', '791344303', '100904785', '391776109', '491382906',
		                            '791320332', '391785954', '192035737', '193686319', '391935892', '291809410', '600183248', '591043310', '193642040',
		                            '491627972', '193632899', '192607977', '193589869', '193671938', '491674467', '491336836', '193664205', '193577282',
		                            '192322903', '692258561', '391809139', '192592246', '391840672', '491335416', '491546336', '193651393', '193641108',
		                            '391841533', '691977970', '193643593', '491546004', '791296708', '791280195', '790827061', '192533425', '192031320',
		                            '491528136', '192978150', '192014951', '591039955', '192426307', '491592102', '691914529', '491052840', '591037383',
		                            '491227771', '692197924', '791222845', '692188625', '193495007', '191451701', '193562620', '591708089', '791279254',
		                            '193592613', '193154604', '291707808', '193454177', '190908260', '491429180', '391853617', '590373024', '591182174',
		                            '491227598', '591273983', '491526105', '700192265', '490963626', '192237146', '193139735', '291546997', '391271602',
		                            '790916809', '391309767', '191274599', '193125327', '791021927', '491065351', '191442721', '600102127', '490320109',
		                            '192671808', '201031439', '192538626', '291510978', '590767974', '192011222', '691720141', '191435318', '791189128',
		                            '500134647', '291660880', '491411744', '591033362', '391813104', '791025100', '101522289', '791066714', '191308663',
		                            '100582412', '691587598', '791107636', '192716860', '500065801', '391726602', '100124517', '500016985', '490858817',
		                            '290473286', '391810424', '191150091', '290983548', '290983507', '100027735', '192075193', '600095711', '200244780',
		                            '700181333', '600042065', '390540824', '691795399', '191106976', '500161273', '190639771', '101117830', '390540865')
                        )edu_act
                        on tot_d.report_date = edu_act.report_date
                        
                        left join (
                        	select 
	                            today() - 1 as report_date,
                                sum(bpt.sum) as education_sum_day,
                                round((sum(bpt.sum)/count(bpt.purchase_id)), 2) as education_avg_check
                            from oplati_analytic.bi_pos_type_2023 bpt
                            where bpt.status=1
	                            and created_date::date = today() - 1
                                and bpt.itn in (
     	                            '193775597', '193578419', '491702640', '391942045', '391107791', '193750099', '591970689', '391016033', '192813839',
                                    '191376663', '291754200', '591908766', '491387354', '291800587', '391939022', '193717440', '192972392', '193749492',
                                    '693326300', '193733821', '791347435', '193745308', '193282429', '791351441', '791351495', '291820897', '191275500',
                                    '491345076', '193109714', '691647647', '591757265', '193688337', '193680004', '193679265', '491606786', '791193624',
                                    '193309996', '193698816', '192525546', '193292872', '791349070', '192531356', '291615087', '291830355', '491656083',
                                    '193702738', '691644081', '193703484', '193664723', '193652823', '193669010', '591044914', '591044649', '591044702',
                                    '591044598', '591044608', '291769444', '791344224', '193665638', '791344303', '100904785', '391776109', '491382906',
                                    '791320332', '391785954', '192035737', '193686319', '391935892', '291809410', '600183248', '591043310', '193642040',
                                    '491627972', '193632899', '192607977', '193589869', '193671938', '491674467', '491336836', '193664205', '193577282',
                                    '192322903', '692258561', '391809139', '192592246', '391840672', '491335416', '491546336', '193651393', '193641108',
                                    '391841533', '691977970', '193643593', '491546004', '791296708', '791280195', '790827061', '192533425', '192031320',
                                    '491528136', '192978150', '192014951', '591039955', '192426307', '491592102', '691914529', '491052840', '591037383',
                                    '491227771', '692197924', '791222845', '692188625', '193495007', '191451701', '193562620', '591708089', '791279254',
                                    '193592613', '193154604', '291707808', '193454177', '190908260', '491429180', '391853617', '590373024', '591182174',
                                    '491227598', '591273983', '491526105', '700192265', '490963626', '192237146', '193139735', '291546997', '391271602',
                                    '790916809', '391309767', '191274599', '193125327', '791021927', '491065351', '191442721', '600102127', '490320109',
                                    '192671808', '201031439', '192538626', '291510978', '590767974', '192011222', '691720141', '191435318', '791189128',
                                    '500134647', '291660880', '491411744', '591033362', '391813104', '791025100', '101522289', '791066714', '191308663',
                                    '100582412', '691587598', '791107636', '192716860', '500065801', '391726602', '100124517', '500016985', '490858817',
                                    '290473286', '391810424', '191150091', '290983548', '290983507', '100027735', '192075193', '600095711', '200244780',
                                    '700181333', '600042065', '390540824', '691795399', '191106976', '500161273', '190639771', '101117830', '390540865')
                            group by date_trunc('day', bpt.created_date)
                        )edu_price
                        on tot_d.report_date = edu_price.report_date;"

  "tab_bi_agr_direction_integrated_site":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_integrated_site
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_integrated_site
                        select 
                            report_date,
                            inegr_da.\"name\",
                            inegr_da.itn,
                            type_name,
                            pos_name,
                            amount_prev_day,
                            sum_prev_day,
                            amount_7_day,
                            sum_7_day,
                            amount_prev_month,
                            sum_prev_month,
                            total_amount,
                            total_sum,
                            NULL as payment_link
                        from (
                            SELECT 
                                today()-1 as report_date,
	                            bpt.name AS name,
                                bpt.itn AS itn,
                                pos_name AS pos_name,
                                sum(case when created_date >= today() - interval '1 day' and created_date < today() then 1 else 0 end) AS amount_prev_day,
                                case
                                    when sum(sum) filter (where created_date >= today() - interval '1 day' and created_date < today()) is NULL then 0
                                    else sum(sum) filter (where created_date >= today() - interval '1 day' and created_date < today())
                                end AS sum_prev_day,
                                sum(case when created_date >= today() - interval '7 day' and created_date < today() then 1 else 0 end) AS amount_7_day,
                                case
                                    when sum(sum) filter (where created_date >= today() - interval '7 day' and created_date < today()) is NULL then 0
                                    else sum(sum) filter (where created_date >= today() - interval '7 day' and created_date < today())
                                end AS sum_7_day,
                                sum(case when created_date>=date_trunc('month', today()) - interval '1 month' and created_date < date_trunc('month', today()) then 1 else 0 end) AS amount_prev_month,
                                case
                                    when sum(sum) filter (where created_date >= date_trunc('month', today()) - interval '1 month' and created_date < date_trunc('month', today())) is NULL then 0
                                    else sum(sum) filter (where created_date >= date_trunc('month', today()) - interval '1 month' and created_date < date_trunc('month', today()))
                                end AS sum_prev_month,
                                count(bpt.purchase_id) AS total_amount,
                                SUM(bpt.sum) AS total_sum
                            from oplati_analytic.bi_pos_type bpt
                            where status = 1 and device_id in (
                                select distinct cash_id
                                from oplati_analytic.spr_cashbox_area 
                                where reg_num in (
                                    select reg_num from (
                                        select * from (
                                            select reg_num
                                            from oplati_analytic.bi_organisation_payments bop 
                                            left join oplati_analytic.spr_pos_area spa
                                            on bop.org_id =spa.org_id 
                                            left join oplati_analytic.spr_cashbox_area sca
                                            on sca.pos_id=spa.pos_id
                                            where bop.org_id not in (
                                                613278,311490,73670,134259,615279,141122,155007,168413,173531,
                                                218394,223318,228876,233174,233184,235296,237365,240479,244250,
                                                244253,245985,249123,249921,253424,253475,254145,257255,257324,
                                                257684,257869,260198,260230,261349,264486,268937,269657,271762,
                                                272622,275136,277032,282822,283466,289171,289206,293619,296201,
                                                297026,299674,299721,302694,302704,306193,307979,310841,311310,
                                                312584,316047,320383,321239,331515,333889,333895,333933,340333,
                                                347507,347563,352317,355739,355844,357260,357276,361937,366062,
                                                367586,370160,370813,373117,373121,373653,373792,373813,374354,
                                                374500,378586,379133,379143,380597,382895,386232,388455,389687,
                                                390667,393363,420876,429226,429267,436599,457863,460856,464337,
                                                465095,486361,511141,517442,519131,525118,526305,534824,539022,
                                                54305,544949,546538,552659,552989,557715,557971,574266,605268,
                                                606533,622793,631426,633700,634415,646060,647029,652950,653266,
                                                653274,656376,657019,657992,659001,659009,659676,663924,664652,
                                                668843,669094,684326,684518,701745,77790
                                            )
                                             and sca.cashbox_type=3 
                                             and type_name not in ('Пассажирские перевозки','Вендинговые аппараты', 'АЗС', 'Водоматы', 'Автомойки')
                                             and itn <>'192812526' and itn<>'100993744'
                                             and itn<>'193009535' and itn<>'102391623'
                                             and sca.cash_id<>6112 and sca.cash_id<>9411
                                             and sca.close_date is null
                                        ) ddd
                                        left join oplati_analytic.spr_poi_app_channels ttt
                                        on ddd.reg_num = ttt.cashbox_number 
                                    ) aa where id = 0
                                )
                            ) group by bpt.name, bpt.itn, pos_name 
                        ) inegr_da
                        left join oplati_analytic.bi_organisation_payments bop 
                        on bop.itn = inegr_da.itn;"

  "tab_bi_agr_direction_entertainment":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_direction_entertainment
    datetime_field: report_date
    recount_period: day
    clickhouse_query: "insert into oplati_views_report.bi_agr_direction_entertainment
                        select
	                        today() - 1 as report_date,
	                        sep.company_name AS company_name,
                            bo.unp AS unp,
                            bo.name AS name,
                            sum(case when buy_date >= today() - interval '1 day' and buy_date < today() then 1 else 0 end) AS amount_prev_day,
                            case
                            	when sum(price) filter (where buy_date >= today() - interval '1 day' and buy_date < today()) is NULL then 0
                                else sum(price) filter (where buy_date >= today() - interval '1 day' and buy_date < today())
                            end AS sum_prev_day,
                            sum(case when buy_date >= today() - interval '7 day' and buy_date < today() then 1 else 0 end) AS amount_7_day,
                            case
                            	when sum(price) filter (where buy_date >= today() - interval '7 day' and buy_date < today()) is NULL then 0
                                else sum(price) filter (where buy_date >= today() - interval '7 day' and buy_date < today())
                            end AS sum_7_day,
                            sum(case when buy_date >= date_trunc('month', today()) - interval '1 month' and buy_date < date_trunc('month', today()) then 1 else 0 end) AS amount_prev_month,
                            case
                            	when sum(price) filter (where buy_date >= date_trunc('month', today()) - interval '1 month' and buy_date < date_trunc('month', today())) is NULL then 0
                                else sum(price) filter (where buy_date >= date_trunc('month', today()) - interval '1 month' and buy_date < date_trunc('month', today()))
                            end AS sum_prev_month,
                            count(bet.id) AS total_amount,
                            SUM(bet.price) AS total_sum,
                            'Total' as type_group
                        from oplati_analytic.bi_entertainment_ticket bet
                        left join oplati_analytic.spr_entertainment_point sep on sep.id ::Float64 = bet.object_id :: Float64
                        left join oplati_analytic.bi_organisation bo on sep.company_id = bo.profile_id
                        left join oplati_analytic.spr_poi_app_category spr on sep.category_id = spr.id
                        where status='BUY'
                        GROUP BY sep.company_name, bo.unp, bo.name

                        union all

                        select
                            today() - 1 as report_date,
	                        sep.company_name AS company_name,
                            bo.unp AS unp,
                            bo.name AS name,
                            sum(case when buy_date >= today() - interval '1 day' and buy_date < today() then 1 else 0 end) AS amount_prev_day,
                            case
                                when sum(price) filter (where buy_date >= today() - interval '1 day' and buy_date < today()) is NULL then 0
                                else sum(price) filter (where buy_date >= today() - interval '1 day' and buy_date < today())
                            end AS sum_prev_day,
                            sum(case when buy_date >= today() - interval '7 day' and buy_date < today() then 1 else 0 end) AS amount_7_day,
                            case
                                when sum(price) filter (where buy_date >= today() - interval '7 day' and buy_date < today()) is NULL then 0
                                else sum(price) filter (where buy_date >= today() - interval '7 day' and buy_date < today())
                            end AS sum_7_day,
                            sum(case when buy_date >= date_trunc('month', today()) - interval '1 month' and buy_date < date_trunc('month', today()) then 1 else 0 end) AS amount_prev_month,
                            case
                                when sum(price) filter (where buy_date >= date_trunc('month', today()) - interval '1 month' and buy_date < date_trunc('month', today())) is NULL then 0
                                else sum(price) filter (where buy_date >= date_trunc('month', today()) - interval '1 month' and buy_date < date_trunc('month', today()))
                            end AS sum_prev_month,
                            count(bet.id) AS total_amount,
                            SUM(bet.price) AS total_sum,
                            'Other' as type_group
                        from oplati_analytic.bi_entertainment_ticket bet
                        left join oplati_analytic.spr_entertainment_point sep on sep.id :: Float64 = bet.object_id :: Float64
                        left join oplati_analytic.bi_organisation bo on sep.company_id = bo.profile_id
                        left join oplati_analytic.spr_poi_app_category spr on sep.category_id = spr.id
                        where status = 'BUY' and bo.unp = '100193541'
                        GROUP BY sep.company_name, bo.unp, bo.name;"

  "tab_bi_agr_integrated_site_daily":
    clickhouse_query: "insert into oplati_views_report.bi_agr_integrated_site_daily
                        select 
                            inegr_day.report_date,
                            amount_operation,
                            amount_cashbox
                        from (
                            select 
	                            created_date::date as report_date,
	                            count(*)  as amount_operation
                            from oplati_analytic.bi_pos_type_2023 
                            where created_date ::date =  today() - 1
                             and status = 1
                             and device_id  in (
                                select distinct cash_id
                                from oplati_analytic.spr_cashbox_area
                                where reg_num in (
                                    select reg_num from (
                                        select * from (
                                            select reg_num
                                            from oplati_analytic.bi_organisation_payments bop 
                                            left join oplati_analytic.spr_pos_area spa
                                            on bop.org_id = spa.org_id 
                                            join oplati_analytic.spr_cashbox_area sca
                                            on sca.pos_id=spa.pos_id
                                            where bop.org_id not in (
                                                613278,311490,73670,134259,615279,141122,155007,168413,173531,218394,
                                                223318,228876,233174,233184,235296,237365,240479,244250,244253,245985,
                                                249123,249921,253424,253475,254145,257255,257324,257684,257869,260198,
                                                260230,261349,264486,268937,269657,271762,272622,275136,277032,282822,
                                                283466,289171,289206,293619,296201,297026,299674,299721,302694,302704,
                                                306193,307979,310841,311310,312584,316047,320383,321239,331515,333889,
                                                333895,333933,340333,347507,347563,352317,355739,355844,357260,357276,
                                                361937,366062,367586,370160,370813,373117,373121,373653,373792,373813,
                                                374354,374500,378586,379133,379143,380597,382895,386232,388455,389687,
                                                390667,393363,420876,429226,429267,436599,457863,460856,464337,465095,
                                                486361,511141,517442,519131,525118,526305,534824,539022,54305,544949,
                                                546538,552659,552989,557715,557971,574266,605268,606533,622793,631426,
                                                633700,634415,646060,647029,652950,653266,653274,656376,657019,657992,
                                                659001,659009,659676,663924,664652,668843,669094,684326,684518,701745,77790
                                            )
                                             and sca.cashbox_type=3 
                                             and type_name not in ('Пассажирские перевозки','Вендинговые аппараты', 'АЗС', 'Водоматы', 'Автомойки')
                                             and itn <>'192812526' and itn<>'100993744'
                                             and itn<>'193009535' and itn<>'102391623'
                                             and sca.cash_id<>6112 and sca.cash_id<>9411
                                             and sca.close_date is null
                                        ) ddd
                                        left join oplati_analytic.spr_poi_app_channels ttt
                                        on ddd.reg_num = ttt.cashbox_number 
                                    ) aa where id = 0
                                )
                            ) group by created_date::date
                        )inegr_day

                        left join (
                            select
                                open_date::date as report_date,
                                count(*) as amount_cashbox
                            from (
                                select
                                    reg_num,
                                    sca.open_date as open_date
                                from oplati_analytic.bi_organisation_payments bop 
                                left join oplati_analytic.spr_pos_area spa
                                on bop.org_id =spa.org_id 
                                join oplati_analytic.spr_cashbox_area sca
                                on sca.pos_id=spa.pos_id
                                where bop.org_id not in (
                                    613278,311490,73670,134259,615279,141122,155007,168413,173531,218394,
                                    223318,228876,233174,233184,235296,237365,240479,244250,244253,245985,
                                    249123,249921,253424,253475,254145,257255,257324,257684,257869,260198,
                                    260230,261349,264486,268937,269657,271762,272622,275136,277032,282822,
                                    283466,289171,289206,293619,296201,297026,299674,299721,302694,302704,
                                    306193,307979,310841,311310,312584,316047,320383,321239,331515,333889,
                                    333895,333933,340333,347507,347563,352317,355739,355844,357260,357276,
                                    361937,366062,367586,370160,370813,373117,373121,373653,373792,373813,
                                    374354,374500,378586,379133,379143,380597,382895,386232,388455,389687,
                                    390667,393363,420876,429226,429267,436599,457863,460856,464337,465095,
                                    486361,511141,517442,519131,525118,526305,534824,539022,54305,544949,
                                    546538,552659,552989,557715,557971,574266,605268,606533,622793,631426,
                                    633700,634415,646060,647029,652950,653266,653274,656376,657019,657992,
                                    659001,659009,659676,663924,664652,668843,669094,684326,684518,701745,77790
                                ) and sca.cashbox_type=3 
                                 and type_name not in ('Пассажирские перевозки','Вендинговые аппараты', 'АЗС', 'Водоматы', 'Автомойки')
                                 and itn <>'192812526' and itn<>'100993744'
                                 and itn<>'193009535' and itn<>'102391623'
                                 and sca.cash_id<>6112 and sca.cash_id<>9411
                                 and sca.close_date is null
                            ) ddd
                            left join oplati_analytic.spr_poi_app_channels ttt
                            on ddd.reg_num = ttt.cashbox_number 
                            where open_date::date = today() - 1 and id = 0
                            group by open_date::date
                        ) cash_inter
                        on inegr_day.report_date = cash_inter.report_date;"

  "tab_bi_agr_integrated_site_monthly":
    overwrite_period: overwrite
    clickhouse_schema: oplati_views_report
    clickhouse_table: bi_agr_integrated_site_monthly
    datetime_field: report_date
    recount_period: month
    clickhouse_query: "insert into oplati_views_report.bi_agr_integrated_site_monthly
                        select 
	                        created_date::date as report_date,
	                        round(avg(sum), 2)  as avg_check,
	                        round(sum(sum), 2) as total_turnover
                        from oplati_analytic.bi_pos_type_2023 
                        where created_date ::date =  today() - 1
                         and status = 1
                         and device_id  in (
                            select distinct cash_id
                            from oplati_analytic.spr_cashbox_area
                            where reg_num in (
                                select reg_num from (
                                    select * from (
                                        select reg_num
                                        from oplati_analytic.bi_organisation_payments bop 
                                        left join oplati_analytic.spr_pos_area spa
                                        on bop.org_id =spa.org_id 
                                        join oplati_analytic.spr_cashbox_area sca
                                        on sca.pos_id=spa.pos_id
                                        where bop.org_id not in (
                                        613278,311490,73670,134259,615279,141122,155007,168413,173531,218394,
                                        223318,228876,233174,233184,235296,237365,240479,244250,244253,245985,
                                        249123,249921,253424,253475,254145,257255,257324,257684,257869,260198,
                                        260230,261349,264486,268937,269657,271762,272622,275136,277032,282822,
                                        283466,289171,289206,293619,296201,297026,299674,299721,302694,302704,
                                        306193,307979,310841,311310,312584,316047,320383,321239,331515,333889,
                                        333895,333933,340333,347507,347563,352317,355739,355844,357260,357276,
                                        361937,366062,367586,370160,370813,373117,373121,373653,373792,373813,
                                        374354,374500,378586,379133,379143,380597,382895,386232,388455,389687,
                                        390667,393363,420876,429226,429267,436599,457863,460856,464337,465095,
                                        486361,511141,517442,519131,525118,526305,534824,539022,54305,544949,
                                        546538,552659,552989,557715,557971,574266,605268,606533,622793,631426,
                                        633700,634415,646060,647029,652950,653266,653274,656376,657019,657992,
                                        659001,659009,659676,663924,664652,668843,669094,684326,684518,701745,77790
                                        )
                                         and sca.cashbox_type=3 
                                         and type_name not in ('Пассажирские перевозки','Вендинговые аппараты', 'АЗС', 'Водоматы', 'Автомойки')
                                         and itn <>'192812526' and itn<>'100993744'
                                         and itn<>'193009535' and itn<>'102391623'
                                         and sca.cash_id<>6112 and sca.cash_id<>9411
                                         and sca.close_date is null
                                    ) ddd
                                    left join oplati_analytic.spr_poi_app_channels ttt
                                    on ddd.reg_num = ttt.cashbox_number 
                                ) aa where id = 0
                            )
                        )
                        group by created_date::date;"
